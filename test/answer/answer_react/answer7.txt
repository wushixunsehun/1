Changelogs 在 Lustre 文件系统中主要用于记录文件系统元数据变更事件，如文件创建、删除、重命名、属性变更等。这些记录包含操作类型、时间戳、用户信息、文件标识符 (FID)、客户端 NID 等关键信息，能够用于多种用途，例如捕获最近的更改并存入归档系统、完成文件系统镜像的变更精确复制、设置监测脚本以作用于某些事件或目录、维护粗略的审计跟踪等。此外，Changelogs 还可用于审计，以跟踪和评估系统操作，特别是在需要保护信息资产和合理分发信息的场景中。启用 Changelogs 功能需要注册用户，并通过 lctl 和 lfs 命令进行管理，包括注册、注销、清除记录以及设置记录类型。对于审计功能，还需启用特定的记录类型如 OPEN、ATIME、GETXATTR 和 DENIED OPEN 等，同时可通过 nodemap 控制哪些客户端触发审计日志。1. Changelogs 的主要用途包括：记录文件系统元数据变更事件，如文件创建、删除、重命名、属性变更等；用于捕获最近的更改并存入归档系统；完成文件系统镜像的变更精确复制；设置监测脚本以作用于某些事件或目录；维护粗略的审计跟踪。2. 启用 Changelogs 功能需要通过 lctl 命令注册用户，例如运行 `lctl --device fsname-MDTnumber changelog register`。注册完成后，Changelogs 功能被打开，用户可以通过 lfs changelog 命令显示记录，并通过设置 `changelog_mask` 控制记录的操作类型。3. 关闭 Changelogs 功能可以通过注销用户实现，例如运行 `lctl --device mdt_device changelog deregister userid`，这相当于执行 `lfs changelog clear` 命令清除记录。此外，可以通过 `lfs changelog clear` 命令为特定用户清除老的记录，释放磁盘空间。4. 对于审计功能，需要启用特定的记录类型，例如运行 `lctl set param mdd.lustre-MDT0000.changelog_mask=ALL` 以启用所有记录类型。同时，可以通过 nodemap 条目上的 audit mode 标志控制哪些客户端触发审计日志，设置为 1 表示允许触发，设置为 0 则禁止触发。5. 具体的命令示例包括：使用 `lfs changelog` 显示记录，使用 `lfs changelog clear` 清除记录，使用 `lctl get param` 查看当前的 changelog_mask 设置，使用 `lctl set param` 修改 changelog_mask 设置。6. 在启用审计功能时，需要注意性能影响，因为记录 OPEN、GETXATTR 等事件可能会增加系统负载。此外，对于 DENIED OPEN 条目，受速率限制，每个时间间隔每个用户每个文件不得超过一个条目，可通过 `mdd.<mdtname>.changelog_deniednext` 设置时间间隔。7. 如果需要防止某些节点（如备份、HSM 代理）使审计日志溢出，可以在 per-nodemap 基础上使用审计功能，通过 `lctl nodemap modify` 命令修改 nodemap 条目的 audit mode 标志。8. 最后，Changelogs 记录的格式包含操作类型、时间戳、日期戳、标志、目标 FID、扩展标志、用户 ID/GID、客户端 NID、父 FID 和目标名称等信息，具体格式为 `rec# operation type timestamp datestamp flags t=target FID ef=extended_flags u=uid:gid nid=client NID p=parent_FID target name`。
