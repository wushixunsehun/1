{
    "query": "如何排查TH-eX上运行作业报 Bus error的错误？",
    "summaries": [
        "TH-ES系统用户在使用四个进程、每个进程占用一个GPU时，程序异常终止。问题出现在脚本中使用后台执行命令，导致yhrun任务在脚本结束后提前回收节点。解决方案是移除最后一个命令的&符号，或完善脚本监控所有进程结束再退出，确保任务正常完成。",
        "FT3000编译CESM2.1.3时出现两个报错。报错1为BOZ字面量常量错误和符号未定义，解决方法是在Macros.make中FFLAGS添加`-fallow-invalid-boz`。报错2为链接时缺少LAPACK库函数引用，解决方法是在构建命令中添加LAPACK和OpenBLAS库路径及链接参数。",
        "TH-3F系统运行calypso.x和vasp时出现“Requested nodes are busy”错误，导致作业无法提交。问题可能由节点资源不足或内存分配不当引起。解决方法包括：将vasp作业核数从64改为56以减少资源占用；在yhrun命令中添加mem=100GB限制内存使用；尝试使用mpi-n编译的vasp并用mpirun调用。此外，建议设置NPAR=4、KPAR=1以优化计算效率。"
    ],
    "contents": [
        "in function `matrix_operations_MOD_cholesky_factor':\nmatrix_operations.F90:(.text+0x69c): undefined reference to `dpoequ_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: matrix_operations.F90:(.text+0x780): undefined reference to `dpotrf_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: matrix_operations.F90:(.text+0x874): undefined reference to `dlaqsy_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: matrix_operations.F90:(.text+0x15cc): undefined reference to `dpoequ_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/lib//libatm.a(lapack_wrap.o): in function `lapack_wrap_MOD_band_solve':\nlapack_wrap.F90:(.text+0x3fc): undefined reference to `dgbsv_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/lib//libatm.a(lapack_wrap.o): in function `lapack_wrap_MOD_band_solvex':\nlapack_wrap.F90:(.text+0xb08): undefined reference to `dgbsvx_'\n/usr/local/THAquila/lib/gcc",
        "【已解决】TH-3F系统计算calypso.x & vasp (Requested nodes are busy)\n**标签**: calypso.x & vasp\n**创建时间**: 2022-11-08 15:42:14\n**更新时间**: 2022-11-08 15:42:14\n**作者**: 刘栋杰\n**问题**：(Requested nodes are busy)\nTH-3F系统计算calypso.x & vasp\n运行脚本\ncaly.sh\n#!/bin/bash\n#SBATCH  job-name=lixing\n#SBATCH  output=log.out.%j\n#SBATCH  error=log.err.%j\n#SBATCH  partition=thcp1\n#SBATCH  nodes=1\nexport UCX_TLS=sm,tcp\n# module load fftw/3.3.8-gcc4.9.3  # 环境里已加载，这行注释或删除\nmodule load python/2.7.18\n./calypso.x > caly.log 2>&1  # 此行进行修改\nsubmit.sh\n#!/bin/sh\nexport UCX_TLS=sm,tcp,glex\nEXE=vasp_std # choose one vasp version to run. e.g. vasp / vasp_ncl / vasp_gam / vasp_neb ...\nkillall -9 $EXE\nyhrun -p thcp1 -n  56 exclusive -w $SLURM_NODELIST mem=100GB $EXE > log 2>&1\n如果使用64核作业还是存在被杀的情况，建议使用56核进行计算，把脚本中64改成56即可。\n报错1\nyhrun: Job 1663451 step creation temporarily disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step",
        "retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\nyhrun: Job 1663451 step creation still disabled, retrying (Requested nodes are busy)\n测试方案1 无效\n尝试设置作业内存， `step creation temporarily disabled, retrying (Requested nodes are busy)`的原因是，首先执行的`yhrun`命令分配了所有内存。 为了解决这个问题，首先可选（？）在`yhbatch`中指定总内存分配：\n#SBATCH mem=120GB   #此参数暂时先不设置，不设置默认使用全部，物理内存128G，去除其他内存开销，限制124G可正常提交作业。\nvasp脚本\nyhrun 增加 mem=100GB # vasp使用内存限制在100GB，可根据需求调整\n测试方案2 无效\nkill vasp 进程后进行等待\n#!/bin/sh\nexport UCX_TLS=sm,tcp,glex\nEXE=vasp_std # choose one vasp version to run. e.g. vasp / vasp_ncl / vasp_gam / vasp_neb ...\nkillall -9 $EXE\nsleep 1s\nyhrun -p thcp1 -n  56 exclusive -w $SLURM_NODELIST mem=100GB $EXE >",
        "[已解决] TH-ES系统用户程序异常结束问题\n**标签**: ES系统，GPU\n**创建时间**: 2021-12-03 14:51:32\n**更新时间**: 2021-12-24 09:17:26\n**作者**: 傅浩\n**问题**：TH-ES系统用户计算任务异常结束问题\n问题描述\n用户反应程序在使用单节点单进程的情况下可以正常执行，但在使用四个进程，每个进程使用一个GPU设备时，会异常终止，使用脚本信息如下：\n#!/bin/bash\n# test.sh\n./QPM001 &\n./QPM002 &\n./QPM003 &\n./QPM004 &\n任务提交命令为：\nnohup yhrun -N 1 -p TH_GPU ./test.sh &\n输出文件正常，无任何报错信息。\n问题分析\n`yhrun`命令返回的时`test.sh`命令的执行结果，而在`test.sh`文件中，采用后台方式执行了四条命令，每个命令均已后台方式执行，在四条命令执行后，系统判断`test.sh`执行完成，`yhrun`在脚本退出后会判断任务执行结束，因此会回收计算节点，导致任务异常终止。\n解决方案\n移除`test.sh`脚本中最后一行的`&`符号，即修改后的脚本内容为：\n#!/bin/bash\n# test.sh\n./QPM001 &\n./QPM002 &\n./QPM003 &\n./QPM004\n**注意**：这种解决的前提假设为最后一个命令是最后一个结束的命令，如果之前的命令计算时间超过最后一个命令，则在QPM004结束之后尚未计算完成的命令仍然会异常退出。\n比较完善的解决方法是，在提交四个进程的命令后，后台监控命令执行情况，如果所有命令均已经退出，则退出整个脚本，最终解决方案如下：\n#!/bin/bash\n# test.sh\n./QPM001 2>&1 | tee QPM002.log &\n./QPM002 2>&1 | tee QPM002.log &\n./",
        "function `lapack_wrap_MOD_band_solvex':\nlapack_wrap.F90:(.text+0xb08): undefined reference to `dgbsvx_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/lib//libatm.a(lapack_wrap.o): in function `lapack_wrap_MOD_tridag_solve':\nlapack_wrap.F90:(.text+0x110c): undefined reference to `dgtsv_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/lib//libatm.a(lapack_wrap.o): in function `lapack_wrap_MOD_tridag_solvex':\nlapack_wrap.F90:(.text+0x1594): undefined reference to `dgtsvx_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: ../../gnu/mpich/nodebug/nothreads/mct/noesmf/lib//libclm.a(SoilWaterMovementMod.o): in function `soilwatermovementmod_MOD_soilwater_moisture_form':\nSoilWaterMovementMod.F90:(.text+0x14f0): undefined reference to `dgtsv_'\n解决：\n在cesm2.1.3/scratch/test/bld/cpl/obj\n最后的命令段添加：-L/thfs4/software/public/env/ft3000env202403/TH-HPML/sve/lapack/lib -llapack -L/thfs4/software/public/env/ft3000env202403/TH-HPML/sve/openblas/lib -lopenblas\n即：\nmpif90  -o /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/cesm.exe",
        "【已解决】FT3000编译CESM2.1.3报错\n**标签**: 无标签\n**创建时间**: 2024-03-27 15:58:13\n**更新时间**: 2024-03-27 16:09:40\n**作者**: 张天奇\n报错1：\nError: BOZ literal constant at (1) is neither a data-stmt-constant nor an actual argument to INT, REAL, DBLE, or CMPLX intrinsic function [see ‘-fno-allow-invalid-boz’]\nError: Symbol ‘gen_hash_key_offset’ at (1) has no IMPLICIT type; did you mean ‘gen_hashkey’?\n解决：\n修改Macros.make\nFFLAGS后加上：-fallow-invalid-boz\n即：\nFFLAGS :=   -fconvert=big-endian -ffree-line-length-none -ffixed-line-length-none -fallow-invalid-boz\n报错2：\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/lib//libatm.a(matrix_operations.o): in function `matrix_operations_MOD_symm_matrix_eigenvalues':\nmatrix_operations.F90:(.text+0xe4): undefined reference to `dsyev_'\n/usr/local/THAquila/lib/gcc/aarch64-unknown-linux-gnu/11.1.0/../../../../aarch64-unknown-linux-gnu/bin/ld: /thfs4/home/zhangtq3/CESM/cesm2.1.3/scratch/test/bld/lib//libatm.a(matrix_operations.o): in function `matrix_operations_MOD_cholesky_factor':\nmatrix_operations.F90:(.text+0x69c): undefined reference to `dpoequ_'\n/usr/local/THAquila/",
        "vasp_neb ...\nkillall -9 $EXE\nsleep 1s\nyhrun -p thcp1 -n  56 exclusive -w $SLURM_NODELIST mem=100GB $EXE > log 2>&1\n无效\n测试方案3\nmpi-n编译vasp，使用mpirun调用，可正常运行，计算速度略慢。\n#!/bin/sh\n#SBATCH exclusive\n#SBATCH -w $SLURM_NODELIST\n#SBATCH mem=80GB\nexe=/thfs1/home/yanggc/5.4.4-opblas-gcc9.3.0-mpi-x/mpi-n/vasp_std\nexport UCX_TLS=sm,tcp\nkillall -9 vasp_std\nsleep 1s\nmpirun -np 64  $exe > log 2>&1\nVASP参数设置\n建议设置:   其中单节点测试中，32~56核，以下参数最优。\nNPAR = 4\nKPAR = 1"
    ]
}