{
    "query": "用户需要在cp4分区提交一个MPI并行作业，要求使用112个进程。请写出完整的提交脚本和命令，并解释资源分配逻辑。",
    "summaries": [
        "本文档介绍了TH-eX系统中作业提交的几种方式。对于MPI+OpenMP并行作业，用户需编写提交脚本sub.sh，例如使用14个进程和8个OpenMP线程，需2个计算节点。交互式作业使用yhrun命令提交，注意输入输出重定向以避免任务中断。文档还提供了LAMMPS、GROMACS、NAMD和WRF等应用软件的提交示例。任务取消使用yhcancel命令，遇到问题可联系技术支持。",
        "ex系统通过Singularity容器运行HPC系统的MPI程序。需复制Intel编译器、IntelMPI及依赖库至本地，并设置环境变量。提交脚本中需配置PERL、PATH、LD_LIBRARY_PATH等，确保容器内正确加载依赖。关键参数包括`I_MPI_SHM_LMT=shm`、`SLURM_MPI_TYPE=pmi2`，避免MPI错误。使用HPC镜像`/fs2/software/node/redhat-7.2.sif`执行`par.exe`。",
        "TH-EX系统用户手册摘要：作业通过jobid标识，用户可查看详细信息。若作业长时间处于CG状态，表示未正常退出，系统管理员会定期处理；若变为$状态，表示系统维护中，完成后恢复。系统支持批处理作业提交（yhbatch）和交互式提交（yhrun），并提供多种参数选项，如指定进程数(-n)、节点数(-N)、分区(-p)等。批处理作业脚本需以#!开头，指定解释器，适合大多数作业提交。MPI并行作业示例中，用户需确保申请的资源不小于脚本中的需求。OpenMP作业只能在单节点运行，线程数不超过56。"
    ],
    "contents": [
        "明细其中jobid 表示作业的记号，用户根据目己作业的情况填入即可，之后用户即可以看到该作业十分详细的信息。注意: 用户作业如果长时间为 CG 状态，表示作业没有正常退出，系统管理员会定期扫描 CG 作业并处理，请用户耐心等待，用户作业如果变成 $ 状态，表示系统管理员在维护系统，维护完成后会将用户作业恢复，对用户作业不会造成影响。3. 3 提交作业目前 TH-EX 系统部署的资源管理系统包括多种作业提交方式，包括批处理作业提交方式 yhbatch 和交互作业提交方式 yhrun。作业终止方式为 yhcancel 命令，需要获取作业的 jobid，可以通过 yhq 命令查看获得。20\nSB“< TH-eX 系统用户手册本手册，为了简化和方便用户，只对相关命令做简单介绍，用户如需更多参数选择，则可以通过响应命令后加入--help 的方式，获取帮助信息，或查阅SLURM 相关资料。3.3.1 批处理作业 yhbatch注意:如果没有交互需求，请使用 yhbacth 提交任务。yhbatch 提交的作业终端关闭时不会受到影响，登陆结点 down 机时也不会受到影响，强烈推荐使用 yhbacth 提交任务。yhbatch向资源管理系统提交一个批处理脚本，yhbatch将在脚本成功提交到资源管理系统控制进程并分配作业JobID后立即退出。批处理脚本可能不会被立刻分配资源，而是在排队作业队列中等待，直到资源需求得到满足。当批处理脚本被分配资源后，资源管理系统将在所分配的第一个结点上运行批处理脚本。yhbacth 运行的主要格式如下:yhbatch [options] programyhbacth 包括多个选项，用户最党使用的选项如下:-n, --ntasks=ntasks指定要运行的进程数。请求 yhrun 分配/加载 ntasks 个进程。省缺的情况是每个 CPU 核运行一个进程，但是-c 参数将改变此省缺值。-N, --nodes=minnodes[-maxnodes]请求为此作业至少分配 minnodes 个结点。调度器可能决定在多于 minnodes个结点上启动作业。可以通过指定 maxnodes 限制最多分配的结点数〈如“--nodes=2-4” ) 。最少和最多结氮数可以相同以便指定确切的结氮数《〈如",
        "minnodes个结点上启动作业。可以通过指定 maxnodes 限制最多分配的结点数〈如“--nodes=2-4” ) 。最少和最多结氮数可以相同以便指定确切的结氮数《〈如“--nodes=2-2”将请求两个并且仅仅两个结点) 。如采没有指定-N，省缺的行为是分配足够的结氮以满足-2n 选项的要求。-p, --partition=partition从分区 partition 请求资源。如未指定，则省缺为默认分区。27\nter TH-eX 系统用户手册-t, --time=minutes设置作业的运行时间限制为 minutes 分钟。省缺值为分区的时间限制值。当到达时间限制时，作业的进程将被友送 SIGTERM 以及 SIGKILL 信号终止执行。完整格式为--time=days-hours:minutes:seconds，建议包机时用户使用该选项。-D, --chdir=path加载的作业进程在执行前将工作目录改变到 path 。省缺情况下作业 yhrun 进程的当前工作目录。-], --label在标准输出/标准错误的每行之前添加任务号。通党，远程任务的标准输出和标准错误通过行缓冲直接传递到 yhrun 的标准输出和标准错误。--label 选项将在每行输出前面添加远程任务的 ID。-J, --job-name=jobname指定作业的名字。省缺值是可执行程序的名字 program 。-W, --wait=seconds指定在第一个任务退出后，到终止所有剩余任务之前的等待时间。0 表示无限等待〈60 秒后将发出一个警告) 。省缺值可由系统配置文件中的参数设置。此选项用于确保作业在一个或多个任务提前退出时能够及时终止。-w, --nodelist=nodelist|filename请求指定列表中的结点。分配给作业的将至少包含这些结点。nodelist 可以是逗号分割的结点列表或范围表达式〈如 cn[1-$,7,12]) 。如果包含“/”字符，则nodelist 将会被当作是一个文件名，其中包含了所请求的结点列表。以上选项中，由以 -N -n, -p, -w, -x 等选项最常用，-",
        "ex系统使用singularity运行hpc系统mpi程序\n**标签**: singularity\n**创建时间**: 2023-08-29 15:19:56\n**更新时间**: 2023-08-29 16:11:06\n**作者**: 李跃岩\nex系统使用singularity运行hpc系统mpi程序\n这里使用hpc系统使用intel_compiler 18编译的par.exe举例\n复制环境\n将intel编译器的库文件、intelmpi的库文件及可执行文件都拷贝过来，例如拷贝到：\n`${HOME}/intel18ddd`和`${HOME}/dddmpi18`中来，另外由于par.exe需要metis.so，所以把hpc系统的这个库也拷过来，例如拷贝到：`${HOME}/metis-5.1.0-icc18`，下面将要在ex系统通过singularity容器，用intelmpi并行运行par.exe\n设置PERL\n可以自己安装，也可以拷贝`/usr/share/perl5`到ex系统，例如拷贝到`${HOME}/perl-5.16.3/lib/5.16.3`\n提交脚本\n这里以提交到cp6节点为例，提交脚本如下：\n#!/bin/sh\n#SBATCH -n 256\n#SBATCH -p cp6\nmodule add singularity/3.11.0\nexport PERLLIB=${HOME}/perl-5.16.3/lib/5.16.3:${HOME}/perl-5.16.3/lib/5.16.3/CGI\nexport PATH=${HOME}/dddmpi18/bin:${PATH}\nexport LD_LIBRARY_PATH=${HOME}/dddmpi18/lib:${HOME}/intel18ddd/intel64_lin:${HOME}/metis-5.1.0-icc18:${LD_LIBRARY_PATH}\nexport SLURM_MPI_TYPE=pmi2\nsrun singularity exec  env I_MPI_SHM_LMT=shm env PERLLIB=${PERLLIB} env LD_LIBRARY_PATH=${LD_LIBRARY_PATH} env PATH=${PATH} workdir=${PWD}  /fs2/software/node/redhat-7.2.sif ./par.exe\n脚本解释\n1. `env` 可以通过这个参数将",
        "where args are comannd line arguments for mpiexec (see below),\nexecutable is the name of the eecutable and pgmargs are command line\narguments for the executable. For example the following command will run\nthe MPI progam a.out on 4 processes:\nmpiexec.slurm -n 4 a.out\nmpiexec.slurm supports the following options:\n[-n nprocs]\n[-host hostname]\n[-verbose]\n[-nostdin]\n[-allstdin]\n[-nostdout]\n[-pernode]\n[-config config_file]\n[-help|-?]\n[-man]\n5. `/fs2/software/node/redhat-7.2.sif` 这个是hpc系统的镜像\n6. `SLURM_MPI_TYPE=pmi2` 设置这个或设置`mpi=pmi2`，否则将使用glex网\n7. 若使用glex网，因为pmi版本不一致，会报错【TODO】\n[cn76966:1758336] PMIX ERROR: NOT-FOUND in file client/pmix_client.c at line 562\nAbort(672779791): Fatal error in internal_Init: Other MPI error, error stack:\ninternal_Init(59)....: MPI_Init(argc=(nil), argv=(nil)) failed\nMPII_Init_thread(209):\nMPID_Init(359).......:\nMPIR_pmi_init(152)...: PMIX_Init returned -46",
        "来计算，-ntomp 1 表示每个 mpi 进程局用一个 openmp 线程。> “用户根据自己的需求将相关的 gmx 处理命令写入 sub.sh 脚本即可。\n*REXESrr TH-eX 系统用户手册3.3.3.3 应用软件 NAMD 使用1) 在登陆节点命令行下加载 NAMD 所需环境变量:2) 编写任务脚本 sub.sh 如下:3.3.3.4 应用软件 WRF 使用看登陆节点命令行下加载 WRE 所需环境变量:1) 使用module help 命令可以得到 wrf 的相关信息2) 将wrf 文件夹下的run 目录拷贝到用户的目录下:3) 依据用户需求修改 namelist.input 及相关配置文件4) 编写任务脚本 sub.sh 如下:\n*e* TH-eX 系统用户手册3.4 任务取消 yhcancelyheancel 取消用户运行的任务，命令为 yncancel1 jobid. jobid 可通过先由 yhq 命令碍看。yheancel 命令强制取消任务后，slurm-jobid.out 文件中显示的信息如图 3-1所示:yhrun: Force Te job 12345678Slurmd[cnO]: *** STEP 12345678.0 CANCELLED AT 2021-11-01T12:00:00 *x**yhrun: cnQ: task 0-35:yhrun: : cni: task 36-31:yhrun: xxx: job done3-1 任务取消后显示信息34\nSBTeX ABE4 RASHHHA Pa es A B,J PASE 8 250 SE AS 77 YZ常见问题和解决方法，很难面面俱到，还请您能够谅解。如果您在系统使用过程中遇到任何问题，都可以及时与中心技术人员取得联系。中心技术人员会在收到用户问题反馈后的 24 小时工作时间内给予回复。1. 合同、资源申请使用、应用软件相关问题联系方式:邮箱: service@nscc-tj. cn电话: 022-653755612. 系统使用、作业运行相关问题联系方式:邮箱 : support@nscc-tj.cn (便件问题) / service@nscc-tj cn 〈软件问题)电话: 022-65375560重点提示: 为了",
        "，则nodelist 将会被当作是一个文件名，其中包含了所请求的结点列表。以上选项中，由以 -N -n, -p, -w, -x 等选项最常用，-N 指定结点数，-a指定进程数，-p 指定分区名，-w 指定结氮列表，-X 指定不参加分配的结点列表〈用于排除自己认为有问题的结点) 。用户在 yhbatch 的参数中指定资源分配的需求约束，编写的作业脚本中，也可以使用 yhrun 命令加载计算作业，此时 yhrun 通过环境变量感知已经分配了资源，从而直接创建作业而不再次提交作业。批处理作业的脚本为一个文本文件，脚本第一行以'#!\"字符开头，并制定脚本文件的解释程序，如 sh，bash，frsh , csh 等。这种作业提交方式，适合提交绝大多数作业。如果需要连续执行多个任务的作28\n*REISwar. TH-eX 系统用户手册业，用户可以在脚本中提交多个任务，逐个计算。如前所述，系统中作业的运行分成两步:资源分配与任务加载。批处理作业使用 yhbatch 提交脚本的方式运行，yhbatch 负责资源分配，yhbatch 获取资源后，会在获取资源的第一个结点运行提交的脚本。3.3.1.1 MPI 并行作业举例一:假设用户可执行文件为 aout，需使用 112 个进程并行计算，编写提交脚本sub.sh 如下:使用批处理命令进行作业提交:计算过程中，脚本所在的工作目录中默认会生成以 slurm 开头的.out SCF, DF幕输出的信息会保存到该文件中。注意:yhbatch 申请的资源应当不小于 sub.sh 脚本中 yhrun 申请的资源。3.3.1.2 OpenMP 并行作业OpenMP 文持共享式内存并行，因此单纯的 OpenMP 多线程并行程序只能在单计算结点上运行。由于每个计算结点是 56 个处理器核心数，因此最大线程数设置不能超过 56.如果用户的程序文持该并行方式，知用户可执行文件为aout，需使用 56 个OpenMP 多线程并行计算。编写提交脚本 sub.sh 如下:\n*REIZate TH-eX 系统用户手册提交批处理命令如下:3.3.1.3 MPI+",
        "PATH=${PATH} workdir=${PWD}  /fs2/software/node/redhat-7.2.sif ./par.exe\n脚本解释\n1. `env` 可以通过这个参数将环境送入singularity容器中\n2. `I_MPI_SHM_LMT=shm` 若不加将报错\nFatal error in PMPI_Waitall: Other MPI error, error stack:\nPMPI_Waitall(405)...............: MPI_Waitall(count=7, req_array=0x3d088a0, status_array=0x3d08940) failed\nMPIR_Waitall_impl(221)..........: fail failed\nPMPIDI_CH3I_Progress(623).......: fail failed\npkt_RTS_handler(317)............: fail failed\ndo_cts(662).....................: fail failed\nMPID_nem_lmt_dcp_start_recv(302): fail failed\ndcp_recv(165)...................: Internal MPI error!  Cannot read from remote process\nTwo workarounds have been identified for this issue:\n1) Enable ptrace for non-root users with:\necho 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope\n2) Or, use:\nI_MPI_SHM_LMT=shm\n3. `PERLLIB` 若不加将报错\nCan't locate Switch.pm in @INC (@INC contains: /usr/lib64/perl5 /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/share/perl5 .) at /usr/bin/mpiexec line 49.\n4. `PATH` 若不加将报错\nUnknown option: pmi_args\nUsage:\nmpiexec.slurm args executable pgmargs\nwhere args are comannd line arguments for mpiexec (see below),\nexecutable is the name of the eecutable and pgmargs are command line\narguments",
        "不需要交互，则需使用批处理作业提交方式。3. yhrun 提交的任务，如果没有进行输入输出的重定向，在关闭登陆客户端软件时，会导致任务中断，因此如无特殊需要，在直接使用 yhrun 提交任务时，重定向输入输出，并保留相应的 log 文件，方便遇到问题时，技术人员及时解决。重定向举例如下:>为重定癌符号，2>人1 表示标准错误输出重定癌至标准输出，最后的信表示后台提区方式，这样保证了该任务在登陆客户端关闭时依然保持不中断。4. 再次提示，如无特殊需要请使用批处理作业 yhbatch 提交方式，yhbatch 提交的作业终端关闭后不会受到影响。3.3.3 应用软件作业提交举例3.3.3.1 应用软件 LAMMPS 使用1) 在登陆节点命令行下加载 LAMMPS 所需环境变量:31\n*[了te TH-eX 系统用户手册说明:从 lammps 的版本名称 lammps/24Mar22-icc19.0-mpich-x 可以看出:> 它的版本号是 24Mar22，即 2022-03-24 发布的版本。用户可以依据需求更换其他版本。> ‘EATER ana Intel 19.0.4 和 mpich-x ，相关的 module 环境已被 lammps 模块自动加载。2) 编写任务脚本 sub.sh 如下:> 第一行: 它是一个用/bin/sh 来解析的脚本文件。> FAT: -N 2 表示 2 个节点; -mn112 Ratt 112 cpu 核， Imp_ mpi 是可执行程序的名字;in.test 是输入文件名。kasatat于=pA>oy|pa+aywR3.3.3.2 应用软件 GROMACS 使用1) 在登陆节点命令行下加载 GROMACS 所需环境变量:2) 编写任务脚本 sub.sh 如下:说明:> ”第二行: 用 gmx mpi grompp 进行前期处理。> B=: 用 gmx mpi mdrun 来计算，-ntomp 1 表示每个 mpi 进程局用一个 openmp 线程。> “用户根据自己的需求将相关的 gmx 处理命令写入 sub.sh 脚本即可。\n*REXESrr",
        "方式，知用户可执行文件为aout，需使用 56 个OpenMP 多线程并行计算。编写提交脚本 sub.sh 如下:\n*REIZate TH-eX 系统用户手册提交批处理命令如下:3.3.1.3 MPI+OpenMP 并行作业如果用户的程序文持该并行方式，各用户可执行文件为aout，需使用 14 个进程并行计算，每个进程下开启 8 个 OpenMP 线程，则应使用的计算结点数为14*8/56=2. 2m Herc HAAS sub.sh 如下:加载环境变量，并提交批处理命令:注意: TH-EX 系统上的资源使用抢占式调度方式，即作业在结点上哪怕内运行了一个核的进程，其他作业也无法再分配到该结点上。特别提示:批处理作业提交模式，使用范围很广，由于手册篇幅限制，不能详述，如果您在提交批处理作业的过程中遇到了任何问题，请联系中心技术人员。3.3.2 交互式作业提交 yhrun对于交互式作业，资源分配与任务加载两步均通过 yhrun 命令进行: 当在登录 shell 中执行 yhrun 命令时，yhzrun 首先向系统提交作业请求并等待资源分配，然后在所分配的结点上加载作业任务。yhrun 运行的主要格式如下:yhrun [options] program\nNSz TH-eX 系统用户手册yhrun 包括多个选项，与 yhbatch 类似。示例:1) 在分区 ep4，使用两个结点上运行 hostname$ yhrun -N 2 -n 112 -p cp4 hostnameyhrun: job 4385 queued and waiting for resourcesyhrun: job 4385 has been allocated resourcescn4cn4cn5特别注意:1. yhrun 基本可以蔡代 mpirun，使用 1.3.2 章节推荐的系统自带的 mpi SES译的程序，完全可以使用 ynhrun 提交任务，而不需使用 mpirun.2. yhrun 为交互式作业提交方式，用户如需要和程序进行交互，则选择直接使用 yhrun 提交任务，如果不需要交互，则需使用批处理作业提交方式。3. yhrun 提交的任务，如果没有进行输入输出的重定向，在关闭登陆客户端软件时，会导致任务中断，因此如无特殊需要，在直接使用"
    ]
}