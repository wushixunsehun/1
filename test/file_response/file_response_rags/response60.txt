{
    "query": "当存储卷降级且同时坏盘超过2块时，值班员应如何处理？",
    "summaries": [
        "文本主要描述了存储系统中硬盘故障及处理过程。某硬盘在11小时24分钟内恢复了2.62T数据，操作成功。同时，发现一个卷降级，需检查zpool状态并更换坏盘。部分硬盘出现错误，如“Medium Error”和“Unrecovered read error”，需替换故障设备。若同时坏盘两块及以上，需联系二线处理。此外，ION节点出现连接问题，需检查是否正常或重启，多台ION报警可能涉及网络或供电问题，需挂起作业并联系支持团队。",
        "存储池在降级状态下仍可使用，RAIDZ2格式支持同时损坏两块盘。若配置热备，可允许损坏的盘数为2加热备数量。当存储池状态为DEGRADED时，表示有成员盘故障或错误，需根据提示操作，如更换硬盘或清除错误。挂起状态（SUSPEND）下存储池不可用，需重启或卸载重挂。换盘前需先将坏盘离线，再物理更换，并使用`zpool replace`操作。无热备时，需手动替换损坏盘。",
        "存储池 ost1 处于降级状态，因 slot28_raid 出现故障。系统提示需替换故障盘或使用 zpool clear 标记为已修复。清理后池和盘状态恢复正常，并触发相关事件。在测试池 test 中注入 UNAVAIL 状态后，池也进入降级状态，需添加备用盘并在线。处理降级时，存储池仍可用，RAIDZ2 可容忍两块盘故障，建议配置热备以提高可靠性。"
    ],
    "contents": [
        "11:12:06.219645949 resource.fs.zfs.statechange\nSep 25 2018 11:12:06.363645954 sysevent.fs.zfs.vdev_clear\nSep 25 2018 11:12:06.465645958 sysevent.fs.zfs.resilver_start\nSep 25 2018 11:12:06.465645958 sysevent.fs.zfs.history_event\nSep 25 2018 11:12:06.636645964 sysevent.fs.zfs.history_event\nSep 25 2018 11:12:06.636645964 sysevent.fs.zfs.resilver_finish\nSep 25 2018 11:12:06.706645966 sysevent.fs.zfs.config_sync\n“FAULTED”状态的盘进⾏ clear 清理操作，存储池 ost1 和盘 slot28_raid 的状态恢复正常“ONLINE”。且产⽣“statechange”、“vdev_clear”、“vdev_clear”事件。\n4.4.6.1.4 注⼊“UNAVAIL”状态\n存储池 test 中没有 spare 盘存在。\n注⼊错误信息\n# zinject -d slot32_raid test\n# zpool scrub test\n查看事件\n# zpool events\n# zpool events\nTIME CLASS\nSep 25 2018 17:14:27.331762154 ereport.fs.zfs.vdev.open_failed\nSep 25 2018 17:14:27.331762154 resource.fs.zfs.statechange\nSep 25 2018 17:14:27.398762156 sysevent.fs.zfs.scrub_start\nSep 25 2018 17:14:27.398762156 sysevent.fs.zfs.history_event\nSep 25 2018 17:14:27.452762158 sysevent.fs.zfs.history_event\nSep 25 2018 17:14:27.452762158 sysevent.fs.zfs.scrub_finish\n执⾏ zinject 命令后，没有事件产⽣，“scrub”后产⽣“vdev.open_failed”、“statechange”、“scrub”事件。\n池 test 状态\n# zpool status test\n# zpool status test\npool: test\nstate: DEGRADED\nstatus: One or more devices could not be opened. Sufficient replicas\nexist for\nthe pool",
        "23:11:25\n\n2024]\n2024]\n2024]\n2024]\n2024]\n2024]\n\nsd 15:0:49:0: [sddf] tag#5196 FAILED Result: hostbyte=DID_OK driverbyt\nsd 15:0:49:0: [sddf] tag#5196 Sense Key : Medium Error [current] [desc\nsd 15:0[sddf] tag#5196 Add. Sense: Unrecovered read error”,\n\nsd 15:0:49:0: [sddf] tag#5196 CDB: Read(16) 88 00 00 00 00 65 69 94 49\nblk_update_request: critical medium error, dev sddf, sector 2324616254\n\nZio} pool=ost34-4 vdev=/dev/disk/by-vdev/JBOD34-$39-part1 error=61 type\noss35查询zpool池列表 X oss35查询日志 X oss35查询zpoo|池状态 < oss35:收集日志 X\n\n\"Ntsufficient replicas exist for the pool to continue functioning in a\",\n\"\\tdegraded state.\",\n\n“action: Replace the faulted device, or use ‘zpool clear’ to mark the device\",\n“\\trepaired.\",\n\nont is\n\n\\tNAMESTATEREAD WRITE CKSUM\",\n\"\\tost34-4DEGRADED998 ，\n\"\\t raidz2-9DEGRADED998 ，\n\"\\tJBOD34-$36 ONLINE998 ，\n\"\\tJBOD34-$37 ONLINE998 ，\n\"\\t 3]B0D34-S38 ONLINE@98\"，\n\n“\"\\tJBOD34-S39 FAULTED829@ too many errors\",\n\n“\\t\n\n\"\\tJBOD34-S41 ONLINE89\n\n\"At 3]B0D34-S42 ONLINE日98\n\"At 3]B0D34-S43 ONLINE日98\n\"At 3]B0D34-S44 ONLINE日98\n\"At 3]B0D34-S45 ONLINE日98\n\n“errors: No known data errors”",
        "pool: ost1\nstate: DEGRADED\nstatus: One or more devices are faulted in response to persistent errors.\nSufficient replicas exist for the pool to continue functioning in a\ndegraded state.\naction: Replace the faulted device, or use 'zpool clear' to mark the\ndevice\nrepaired.\nscan: scrub repaired 0B in 0h0m with 0 errors on Tue Sep 25 10:47:36\n2018\nconfig:\nNAME STATE READ WRITE CKSUM\nost1 DEGRADED 0 0 0\nraidz2-0 DEGRADED 0 0 0\nslot20_raid ONLINE 0 0 0\nslot21_raid ONLINE 0 0 0\nslot22_raid ONLINE 0 0 0\nslot23_raid ONLINE 0 0 0\nslot24_raid ONLINE 0 0 0\nslot25_raid ONLINE 0 0 0\nslot26_raid ONLINE 0 0 0\nslot27_raid ONLINE 0 0 0\nslot28_raid FAULTED 0 0 0 too many errors\nslot29_raid ONLINE 0 0 0\nerrors: No known data errors\n将 slot28_raid 置为 faulted 状态后，ost1 状态如上所示。\n查看触发事件\n# zpool events\nSep 25 2018 10:54:00.750608813 resource.fs.zfs.statechange\nSep 25 2018 10:54:00.883608817 sysevent.fs.zfs.config_sync\n在⼿动将池中的盘置为 faulted 状态后，触发了 statechange 事件的产⽣。\n查看注⼊信息\n# zinject\n没有注⼊记录产⽣。\nclear 清理及触发的事件\n# zpool clear ost1\n# zpool events\nTIME CLASS\nSep 25 2018 11:12:06.219645949 resource.fs.zfs.statechange\nSep 25 2018 11:12:06.363645954 sysevent.fs.zfs.vdev_clear\nSep 25 2018 11:12:06.465645958 sysevent.",
        "3]B0D34-S43 ONLINE日98\n\"At 3]B0D34-S44 ONLINE日98\n\"At 3]B0D34-S45 ONLINE日98\n\n“errors: No known data errors”\n如果同时坏盘2块及以上，联系二线处理。\n5.1.4 获取smart值出现异常\n参考5.1.2更换硬盘。\n5.1.5 ION失去连接\n1）某一个ION报警，查看ION是否正常，不正常则重启ION。\n节点状态连接成功，并且查询负载有输出，则ION正常。\n定制大屏aia故障详情运维总览\n\nTH-HPC TH-3F\n\n其他操作 节点操作\n\nion0Q\neq 节点编号: ion0\nG@ © TH-3F\n序号: 4510所属集群: TH-3F硬盘大小: 无硬盘\n日 VO-00\n日 ion节点名称:ion0所属分区:_null硬盘类型: 无硬盘\n剧本执行Diono\n\n节点类型:存储位置: 1903机房-TH-3F-VO-00-39.0\n\n查询日志查询内存清除进程cpu进程排序mem进程排序\nTHeX = TH-3F\n\n其他操作 节点操作一\n\n总览TH-HPC4DPTH-3F\n\n:TH-HPC\n\n剧本编排>TH-eX\n\n1903网络报警ION RABE...SRT RESP in.MDS RBBSP...OST RABEEP...\nRIMSDBRS ME\nO 资源操作\n\n0 用户操作\n\nOf 作业操作\n\n© 服务操作\n\nO 数据拷贝\n\n局 应急操作\n\n=)\n\n查记ipmi日志AAS\n您确定要执行电源管理操作吗?\n\n+ 节点名 。 ion10\n\n+动作 | 重启\n2）多台ion报警\n可能的原因：高速网板卡、IB板卡、机柜供电制冷等问题。\n处理办法：挂起对应集群的作业，联系二线和科大值班人员。\n3）ion重启后报警未消失\n1.确认系统状态，是否可以ping通，是否可以ssh进去。\n2．若没有系统，或开机卡住，观察ib网卡（插一根绿线的）是否有绿灯闪烁或常量。若不亮，更换ib网卡。\n3.若进系统正常，参考5.2.2，处理",
        "# zpool status test\npool: test\nstate: DEGRADED\nstatus: One or more devices could not be opened. Sufficient replicas\nexist for\nthe pool to continue functioning in a degraded state.\naction: Attach the missing device and online it using 'zpool online'.\nsee: http://zfsonlinux.org/msg/ZFS-8000-2Q\nscan: scrub repaired 0B in 0h0m with 0 errors on Tue Sep 25 17:14:27\n2018\nconfig:\nNAME STATE READ WRITE CKSUM\ntest DEGRADED 0 0 0\nraidz1-0 DEGRADED 0 0 0\nslot30_raid ONLINE 0 0 0\nslot31_raid ONLINE 0 0 0\nslot32_raid UNAVAIL 0 0 0 cannot open\nerrors: No known data errors\nslot32_raid 状态变为“UNAVAIL”。\ndmesg 信息\ndmesg 中没有任何信息产⽣。\n注⼊的信息\n# zinject\nID POOL GUID\n--- --------------- ----------------\n1 test ecec77976d8ab0bb\n使⽤“zinject”查询时有注⼊信息产⽣。\n恢复\n恢复的正确步骤：\n⾸先 replace 替换 unavail 状态的盘；\n然后清除注⼊信息；\n再 detach 分离盘。\n# zpool replace test slot32_raid slot33_raid -f\n只能使⽤ replace 去替换“UNAVAIL”状态的盘。但替换之后“UNAVAIL”状态的盘⽆法分离。\n最后删除注⼊错误。\n# zinject -c all\nremoved all registered handlers\n当清除注⼊信息后，“UNAVAIL”状态的盘可是使⽤ detach 进⾏分离。\n4.4.6.2 存储池降级（DEGRADED）处理\n4.4.6.2.1 处理⽅法\n存储池降级状态时存储池依然可⽤，对于 raidz2 格式的存储池是可以同时坏两块成员盘的。因此降级\n状态时存储池依然可⽤。\n如果配置有热备，在设置⾃动",
        "-d slot-13 ost1\n// 注⼊FAULTED错误\n# zinject -d slot-13 －A fault ost1\n// 注⼊ panic 错误\n# zinject -p slot-12 ost1\n// 2、将成员盘下线\n# zpool offline ost1 slot-13\n// 3、直接拔盘\n坏盘状态：\n# zpool status ost1\npool: ost1\nstate: DEGRADED\nstatus: One or more devices could not be used because the label is missing\nor\ninvalid. Sufficient replicas exist for the pool to continue\nfunctioning in a degraded state.\naction: Replace the device using 'zpool replace'.\nsee: http://zfsonlinux.org/msg/ZFS-8000-4J\nscan: scrub repaired 0B in 0h0m with 0 errors on Thu May 21 16:26:28\n2020\nconfig:\nNAME STATE READ WRITE CKSUM\nost1 DEGRADED 0 0 0\nraidz2-0 DEGRADED 0 0 0\nslot-10 ONLINE 0 0 0\nslot-11 ONLINE 0 0 0\nslot-12 ONLINE 0 0 0\nslot-13 UNAVAIL 0 0 0 corrupted data\nslot-14 ONLINE 0 0 0\nslot-15 ONLINE 0 0 0\nslot-16 ONLINE 0 0 0\nslot-17 ONLINE 0 0 0\nslot-18 ONLINE 0 0 0\nslot-19 ONLINE 0 0 0\nerrors: No known data errors\n注意： 有时坏盘时 别名被更换为成员盘的 gid，即 slot-13 更换为 2823177480828651994，在对硬盘进⾏操作时，使⽤该 gid 替换别名\n示例：\n# zpool status ost1\npool: ost1\nstate: DEGRADED\nstatus: One or more devices could not be used because",
        "ONLINE\n3B0D19-S54] ONLINE\n3B0D19-S55] ONLINE\n\neeecesceecee000\nooooooooeooa\noaeoaoaeoeaeoeaeaoae\n\n“errors: No known data errors”\n\nPLAY. RECAP S00; aso Oo ESOS EEE BO BEBO ERE IOOCBEOO UE GO RESO CEE IOC ESOC GEO IOE\n\n89.72.103.18: ok=2changed=1 。 unreachable=-8failed=@ 。 skipped-8 。 rescued-8 —ignored-0\n代表盘在11小时24分钟内恢复了2.62T，恢复完毕。可以关闭硬盘灯。\n您确定要执行标记硬盘操作吗\n\n硬盘 JBOD19-S54\n\n动作 | 关闭\n脚本执行成功，其中Ident=0，表示硬盘已取消点亮。\n5.1.3 xx卷降级\n集群故障点故障原因故障级别发生时间\n\nTH-eXoss35thfs2-0ST005d卷降级e 严重2024-07-13T23:13:09\n通过查询zpool状态检查是否坏盘，如若异常，参考5.1.2更换硬盘。\nTH-eX\nBF 节点操作\n\noss35Q\noof 节点编号: oss35\nEl co TH-eX\n日 yo-37Geen所属集群 TH-eX硬盘大小 BR\n日 storage节点名称: oss35所属分区:_null硬盘类型: 无硬盘\nD oss35节点类型: 存储节点存储位置: 1903机房-TH-eX-VO-37-节点状态:| 连续成功 |\n6.0\n\n清除硬盘设备名查询内存清除用户进程标记硬盘cpu进程排序\nmem进程排序查询硬盘设备名查询负载收集日志查询zpool池列…下线硬盘\n\"[sat\n“[sat\n“[sat\n“[sat\n“[sat\n“[sat\n\nJul 13\nJul 13\nJul 13\nJul 13\nJul 13\nJul 13\n\n23:11:25\n23:11:25\n23:11:25\n23:11:25\n23:11:25\n23:11:25\n\n2024]\n2024]\n2024]\n2024]\n2024]\n2024]\n\nsd 15:0:49:0: [sddf] tag#5196 FAILED Result:",
        "示例中有成员盘坏掉了\nJBOD1-S0 UNAVAIL 0 0 0 cannot open\n硬盘状态为 UNAVAIL。\n通常情况下，出现降级后，可以直接按照 zpool status 中 action 后的提示信息进⾏操作即可。⼀旦降级可⾸先尝试清除错误信息：\n# zpool clear [-F] <存储池> [成员盘]\n如果清除错误信息后错误依然可以尝试更换硬盘。换盘操作请看本章的第四节\n4.4.7 存储池挂起（SUSPEND）处理\n4.4.7.1 处理⽅法\n挂起时存储池状态为 state：suspend。此时存储池已不可⽤。官⽅推荐⽅法（zpool status 中 action\n部分有提示操作信息）是要求重启系统重新挂载即可。\n如果不⽅便重启，可以尝试卸载存储池（甚⾄卸载 zfs 模块）然后重新挂载存储池。\n4.4.8 换盘\n拔出硬盘前，请先将坏盘offline。\n$ zpool offline <pool_name> <vdev_name>\n然后从驱动层删除该硬盘。\n// 找到硬盘盘符\n$ readlink /dev/disk/by-vdev/<vdev_name> | xargs basename\n// 删除硬盘\n$ echo 1 > /sys/block/<vdev_name_label>/device/delete\n4.4.8.1 没有热备盘的存储池换盘\n没有热备盘时，存储池有成员盘损坏，此时需要物理更换新盘，并在存储池中使⽤新盘更换坏盘。\n说明： 本节测试时未使⽤ JBODX_SX 的别名命名⽅式。⽽是使⽤了 slot-X 的别名，不影响具体操作\n测试时需要模拟坏盘，模拟坏盘⽅法：\n该部分为测试需要，实际运维处理问题可略过\n// slot-13 为存储池成员盘 ost1 为存储池\n// 1、注⼊错误\n// 注⼊UNAVAIL错误\n# zinject -d slot-13 ost1\n// 注⼊FAULTED错误\n# zinject -d slot-13 －A fault ost1\n// 注⼊ panic 错误\n# zinject -",
        "法\n存储池降级状态时存储池依然可⽤，对于 raidz2 格式的存储池是可以同时坏两块成员盘的。因此降级\n状态时存储池依然可⽤。\n如果配置有热备，在设置⾃动替换后，可以容许坏盘的数量为 2+热备盘数量。\n如下示例：\n// 此处因为有热备，所以有硬盘坏掉之后会进⾏替换\n# zpool status ost0\npool: ost0\nstate: DEGRADED\nstatus: One or more devices could not be opened. Sufficient replicas\nexist for\nthe pool to continue functioning in a degraded state.\naction: Attach the missing device and online it using 'zpool online'.\nsee: http://zfsonlinux.org/msg/ZFS-8000-2Q\nscan: resilvered 3.10M in 0h0m with 0 errors on Thu Aug 13 15:57:15 2020\nconfig:\nNAME STATE READ WRITE CKSUM\nost0 DEGRADED 0 0 0\nraidz2-0 DEGRADED 0 0 0\nspare-0 DEGRADED 0 0 0\nJBOD1-S0 UNAVAIL 0 0 0 cannot open\nJBOD1-S8 ONLINE 0 0 0\nJBOD1-S1 ONLINE 0 0 0\nJBOD1-S2 ONLINE 0 0 0\nJBOD1-S3 ONLINE 0 0 0\nJBOD1-S4 ONLINE 0 0 0\nJBOD1-S5 ONLINE 0 0 0\nJBOD1-S6 ONLINE 0 0 0\nJBOD1-S7 ONLINE 0 0 0\nspares\nJBOD1-S8 INUSE currently in use\nJBOD1-S9 AVAIL\nerrors: No known data errors\n看到 state: DEGRADED 即表明该存储池降级。通常降级即表明有成员盘坏掉或者是有其他错误。\n示例中有成员盘坏掉了\nJBOD1-S0 UNAVAIL 0 0 0 cannot open\n硬盘状态为 UNAVAIL。\n通常情况下，出现降级后，可以直接按照 zpool status 中 action"
    ]
}