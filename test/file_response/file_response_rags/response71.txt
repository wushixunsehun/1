{
    "query": "如何利用ZFS快照实现LUSTRE文件系统的卷级备份迁移？",
    "summaries": [
        "本文介绍了使用 ZFS 挂载 LUSTRE 文件系统的方法，包括默认挂载点和自定义挂载点的设置。同时详细描述了基于 ZFS 快照的 LUSTRE 文件系统卷级备份迁移流程，包括确认目标卷信息、卸载、生成快照、准备新存储设备、使用 `zfs send`/`recv` 或打包备份进行数据迁移等步骤。重点强调了快照在数据备份中的作用及两种备份方法的适用场景。",
        "本文介绍了在ZFS和Lustre组合文件系统中，如何对存储池（如mds和ost）进行挂载、卸载、设置挂载点以及通过ZFS快照实现Lustre文件系统的卷级数据备份与迁移。关键步骤包括：卸载Lustre文件系统、调整canmount属性、以ZFS格式挂载数据集、创建快照、准备新存储设备并使用`mkfs.lustre`重新格式化，最后通过`zfs send`进行数据备份迁移。",
        "建议使用带有管道的通用备份命令，因其执行速度快。恢复时使用 `zfs recv` 命令导入备份文件，并检查目标卷配置是否与原卷一致，随后刷新目标卷及其他存储卷的配置。重新挂载所有 Lustre 存储卷，确保其状态正常，再挂载客户端进行数据验证和 IOR 测试，确认无数据丢失且 IO 正常后，迁移完成，新存储可正常使用。"
    ],
    "contents": [
        "# zfs mount <数据集>\n示例：\n# zfs mount ost/ost\n# df -Th\nFilesystem     Type      Size  Used Avail Use% Mounted on\n/dev/sda1      ext4       11G  4.4G  5.8G  44% /\ndevtmpfs       devtmpfs  898M     0  898M   0% /dev\n/dev/sda2      ext4      6.8G  1.6G  4.9G  25% /home\nmds            zfs        20G     0   20G   0% /mds\nmds/mds        lustre     20G  1.9M   20G   1% /mnt/mds\nost            zfs        58G     0   58G   0% /ost\nost/ost        zfs        58G  2.2M   58G   1% /ost/ost\n设备 ost/ost 以 zfs 形式挂载时，默认挂载目录为“/ost/ost”。\n由于已经挂载过 lustre 文件系统，里面会有数据，因此在目录“/ost/ost”下会看到数据文件的存在。\n- 设置挂载点 （可选操作）\n设置后自动更改挂载目录。\n# zfs set mountpoint=<挂载点> <数据集>\n5.6 基于 ZFS 快照系统的 LUSTRE 文件系统卷级别整体数据备份迁移\n5.6.1、应用场景与目的\n本文档适用于 **zfs+lustre** 组合的文件系统， 由于某种原因（盘阵问题、RAID 问题）需要将整个存储卷进行备份（卷不会被删除仍会存在）， 实现文件系统卷一级的整体备份迁移。\n5.6.2、要求\n- zfs 基本和快照",
        "格式化\n# mkfs.lustre reformat fsname=<fsname> replace <和需要备份的存储设备相同的配置参数> <新zfs数据集>\n- #### 备份迁移\n以下两种方法任选其一。\n以下两种方法任选其一。\n1、 通用备份恢复方法\n使用 **zfs send** 发送快照，然后使用 **zfs recv** 接收，接收时将会对新生成的存储池进行配置，生成和需要备份的存储池相同的配置信息。\n示例：\n需要备份的存储池: xmds1/mds1\nzfs 快照： xmds1/mds1@2020-07-08-00\n新生成的存储池： mds1/mds1\n新生成的存储池的 zfs 快照： mds1/mds1@2020-07-08-00 （@后面可自定义）\n// 命令\n# zfs send xmds1/mds1@2020-07-08-00 | zfs recv mds1/mds1@2020-07-08-00 -F\n跨服务器备份:\n假设新存储池 mds1 链接在新服务器 xmds2 上, 新存储池配置如上不变\n# zfs send xmds1/mds1@2020-07-08-00 | ssh xmds2 zfs recv mds1/mds1@2020-07-08-00 -F\n**<span style=\"color:red\">如果数据较多（文件系统数据量大），可能上述命令执行比较慢。待命令执行完毕后执行下一步</span>**\n2、 单独备份\n**<span style=\"color:red\">以下为单独备份，将存储池单独备份打包为压缩包，可以随时使用压缩包来恢复存储池。</span>**\n单独备份的命令\n# zfs send xmds1/mds1@2020-07-08-00 > mds1-backup.tar.gz\n**注意: 如果整个文件系统存储数据比较多该步骤会非常耗时，建议使用上述带有管道的命令即通用备份方法，该命令执行速度比较快**\n使用单独备份进行恢复\n- 恢复命令\n# zfs recv mds1/mds1@2020-07-08-00",
        "由于某种原因（盘阵问题、RAID 问题）需要将整个存储卷进行备份（卷不会被删除仍会存在）， 实现文件系统卷一级的整体备份迁移。\n5.6.2、要求\n- zfs 基本和快照\n- lustre 基本和配置修改\n- 需要一套空白存储设备\n5.6.3、操作方法\n- #### 确认需要进行备份的目标卷的信息\n确认该目标卷存储设备是由 zfs 创建的存储池\n确认该存储池名称\n确认迁移的数据集\n**<span style=\"color:red\">df 查看该目标卷挂载时使用的数据集</span>**\n示例:\n待迁移数据集为 mds1/mds1\n# df -t lustre\nFilesystem       1K-blocks    Used   Available Use% Mounted on\nmds1/mds1      10256072448 3250304 10252820096   1% /mnt/mds1\n- #### 卸载\n首先将所有的 lustre 文件系统客户端和目标卷都卸载，包括 client、ost 和 mdt 以及 mgs 等\n- #### 生成需要备份 zfs 数据集的快照\n// mds1/mds1 为zfs数据集\n// @2020-07-08-00 快照自定义标记名称\n# zfs snapshot mds1/mds1@2020-07-08-00\n查看已存在的快照\n# zfs list -t snapshot\nNAME                       USED  AVAIL  REFER  MOUNTPOINT\nmds1/mds1@2020-07-08-00   31.8M      -  3.09G  -\n- #### 准备一套新的存储设备\n将存储连接到服务器，并使用 zfs 进行配置挂载到当前服务器上。也可以连接到另一台服务器并使用 zfs 导入。\n使用以下命令对该存储设备格式化\n# mkfs.lustre reformat fsname=<fsname> replace <和需要备份的存储设备相同的配置参数> <新zfs数据集>\n- #### 备份迁移\n以下两种方法任选其一。",
        "设置数据集 ost/ost 的 canmount 属性\ncanmount 属性决定了是否可以挂载、查看后台数据。\n查看⽂件系统 canmount 属性\n# zfs get canmount <数据集>\n示例：\n# zfs get canmount ost/ost\nNAME PROPERTY VALUE SOURCE\nost/ost canmount off local\nost/ost 默认 canmount 状态为“off”。要将其设置为“on”状态。\n# zfs set canmount=on <数据集>\n示例：\n# zfs get canmount ost/ost\nNAME PROPERTY VALUE SOURCE\nost/ost canmount on local\n此时，设备 canmount 属性为“on”状态。\n以 zfs 格式挂载数据集\n挂载命令：\n# zfs mount <数据集>\n示例：\n# zfs mount ost/ost\n# df -Th\nFilesystem Type Size Used Avail Use% Mounted on\n/dev/sda1 ext4 11G 4.4G 5.8G 44% /\ndevtmpfs devtmpfs 898M 0 898M 0% /dev\n/dev/sda2 ext4 6.8G 1.6G 4.9G 25% /home\nmds zfs 20G 0 20G 0% /mds\nmds/mds lustre 20G 1.9M 20G 1% /mnt/mds\nost zfs 58G 0 58G 0% /ost\nost/ost zfs 58G 2.2M 58G 1% /ost/ost\n设备 ost/ost 以 zfs 形式挂载时，默认挂载⽬录为“/ost/ost”。由于已经挂载过 lustre ⽂件系统，⾥⾯会有数据，因此在⽬录“/ost/ost”下会看到数据⽂件的存在。\n设置挂载点 （可选操作）\n设置后⾃动更改挂载⽬录。\n# zfs set mountpoint=<挂载点> <数据集>\n4.4.10 基于ZFS快照系统的LUSTRE⽂件系统卷级别整体数据备份迁移\n4.4.10.1 应⽤场景与⽬的\n本⽂档适⽤于 zfs+lustre 组合的⽂件系统",
        "<数据集>\n4.4.10 基于ZFS快照系统的LUSTRE⽂件系统卷级别整体数据备份迁移\n4.4.10.1 应⽤场景与⽬的\n本⽂档适⽤于 zfs+lustre 组合的⽂件系统， 由于某种原因（盘阵问题、RAID 问题）需要将整个存储卷进⾏备份（卷不会被删除仍会存在）， 实现⽂件系统卷⼀级的整体备份迁移。\n4.4.10.2 要求\nzfs 基本和快照\nlustre 基本和配置修改\n需要⼀套空⽩存储设备\n4.4.10.3 操作⽅法\n确认需要进⾏备份的⽬标卷的信息\n确认该⽬标卷存储设备是由 zfs 创建的存储池\n确认该存储池名称\n确认迁移的数据集\ndf 查看该⽬标卷挂载时使⽤的数据集\n示例:\n待迁移数据集为 mds1/mds1\n# df -t lustre\nFilesystem 1K-blocks Used Available Use% Mounted on\nmds1/mds1 10256072448 3250304 10252820096 1% /mnt/mds1\n卸载\n⾸先将所有的 lustre ⽂件系统客户端和⽬标卷都卸载，包括 client、ost 和 mdt 以及 mgs 等\n⽣成需要备份 zfs 数据集的快照\n// mds1/mds1 为zfs数据集\n// @2020-07-08-00 快照⾃定义标记名称\n# zfs snapshot mds1/mds1@2020-07-08-00\n查看已存在的快照\n# zfs list -t snapshot\nNAME USED AVAIL REFER MOUNTPOINT\nmds1/mds1@2020-07-08-00 31.8M - 3.09G -\n准备⼀套新的存储设备\n将存储连接到服务器，并使⽤ zfs 进⾏配置挂载到当前服务器上。也可以连接到另⼀台服务器并使⽤zfs 导⼊。\n使⽤以下命令对该存储设备格式化\n# mkfs.lustre --reformat --fsname=<fsname> --replace <和需要备份的存储设备相同的配置参数> <新zfs数据集>\n备份迁移\n以下两种⽅法任选其⼀。\n1、 通⽤备份恢复⽅法\n使⽤ zfs send 发送快照，",
        "ost 为例）：\n存在 2 个存储池 mds 和 ost，“Mount type”是“zfs”，且被格式化为 lustre ⽂件系统的数据集为mds/mds，ost/ost（可以是其他），mds 是元数据存储池。 mds/mds 和 ost/ost 均以 lustre 形式挂载。mds 和 ost 以 zfs 形式挂载。\n# df -Th\nFilesystem Type Size Used Avail Use% Mounted on\n/dev/sda1 ext4 11G 4.4G 5.8G 44% /\ndevtmpfs devtmpfs 898M 0 898M 0% /dev\n/dev/sda2 ext4 6.8G 1.6G 4.9G 25% /home\nmds zfs 20G 0 20G 0% /mds\nmds/mds lustre 20G 1.9M 20G 1% /mnt/mds\nost zfs 58G 0 58G 0% /ost\nost/ost lustre 58G 1.8M 58G 1% /mnt/ost\n以查看设备 ost/ost 中信息为例，⽅法如下：\n卸载 ost/ost\n同⼀个⽂件系统不能以 lustre 和 zfs 同时挂载。\n# umount <挂载点或数据集>\n示例:\n卸载以 lustre 类型挂载的存储池 ost\n# umount ost\n获取存储池 ost 的 canmount 属性\n# get canmount <存储池>\n示例：\n# zfs get canmount ost\nNAME PROPERTY VALUE SOURCE\nost canmount on default\n存储池 ost 默认 canmount 属性为“on”状态。若为“off”状态，要设置为“on”状态。\n设置存储池 ost 的 canmount 属性为 on\n# zfs set canmount=on <存储池>\n示例：\n# zfs set canmount=on ost\n设置数据集 ost/ost 的 canmount 属性\ncanmount 属性决定了是否可以挂载、查看后台数据。\n查看⽂件系统 canmount 属性\n# zfs get canmount <数据集>",
        "，建议使用上述带有管道的命令即通用备份方法，该命令执行速度比较快**\n使用单独备份进行恢复\n- 恢复命令\n# zfs recv mds1/mds1@2020-07-08-00 -F < mds1-backup.tar.gz\n- #### 检查新生成的目标卷的配置\n以下命令获取目标卷配置信息。\n将配置信息与原目标卷作对比，配置应该是相同的\n# tunefs.lustre mds1/mds1\n- #### 刷新目标卷的配置\n# tunefs.lustre writeconf mds1/mds1\n- #### 刷新其他所有存储卷的配置\n// 同上一步中的命令\n# tunefs.lustre writeconf <数据集>\n- #### 挂载与检测\n1、重新挂载所有的 lustre 存储卷；\n2、等待文件系统恢复正常（所有的 lustre 卷都是 healthy 状态）；\n3、挂载 lustre 客户端，检查是否有数据丢失，进行 IOR 测试，检查文件系统 IO 是否正常\n若以上测试通过则存储迁移正常，新存储可以正常使用。"
    ]
}