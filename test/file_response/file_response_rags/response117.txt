{
    "query": "管理员发现 Lustre 集群在高负载时频繁出现 RPC 超时，需通过调整自适应超时机制的历史记录时长和提前回复增量时间，优化客户端与服务器的超时响应策略，应该配置哪些参数？",
    "summaries": [
        "RPC 超时机制通过自适应调整来优化性能。当服务器处理时间接近客户端设定的超时时，会发送“早期回复”以避免超时和重连循环。随着处理速度提升，超时值降低，可更快检测服务故障并进行故障转移。自适应超时参数（如 at_min、at_max、at_early margin 等）可通过命令配置，影响服务器对 RPC 处理时间的估计和客户端超时设置。静态超时用于未启用自适应超时的情况，包括 LND 超时和 Lustre 超时，确保网络通信在故障时能在有限时间内完成。",
        "Lustre 文件系统中的 `sync_on_lock_cancel` 参数用于控制在锁取消时是否同步日志，以避免数据不一致。该参数可设置为 `always`、`blocking` 或 `never`。建议不要禁用此功能，以免数据损坏。此外，Lustre 提供了多个参数来优化客户端元数据 RPC 流，如 `max_rpcs_in_flight` 和 `max_mod_rpcs_in_flight`，用于控制并行元数据操作的数量，从而提升性能。同时，通过 `rpc_stats` 可以监控元数据 RPC 的执行情况，帮助调整参数以适应不同的工作负载。Lustre 还使用自适应超时机制来动态调整 RPC 超时时间，以提高系统稳定性。",
        "本文档介绍了Lustre文件系统的超时设置、LNet监控以及OST空间分配机制。Lustre超时确保RPC故障时在有限时间内完成，自适应超时默认启用，可通过设置at_max=0禁用。LND超时可调整以避免假性超时，增加LNet节点数量或调整超时参数有助于减少背压。LNet监控通过/proc/sys/lnet下的文件进行，包括peers和nis等信息，用于查看网络状态和信用值。OST空间分配根据可用空间的平衡情况选择循环或加权方式，可通过参数调整分配策略。"
    ],
    "contents": [
        "RPC 超时值以允许更多的时间来守成RPC。如宁服务郁上排队的 RPC 接近客户端指定的RPC 超时，为避免 RPC 超时和上断开和重新连接的循环，服务僚会癌客己端发送\" 早期回复\"，告知客户端以允许更多的处理时间。相反，随着服务器处理速度的加快，RPC 超时值会降低，从而能够更快地检测到服务俘无啊应、更快地连接到服务仑的故障转移伙伴。39.5.1. 配置自适应超时下表中的自适应超时参数可以使用 MGS 上的LIct1 conf param命令在系统范围内进行永久设置。例如，为与文件系统testfs关联的所有服务器和客户端设置at_max值:lctl conf param testfs.sys.at_max=1500注意访问多个 Lustre 文件系统的客户端必须对所有文件系统使用相同的参数值。参数 说明at_min EARLE IMMER (以秒为单位)，即服务器会报告的最小处理上时间。默认值为0。理想情况下，应将其设置为默认值。客户端不于接使用此值但将基于此值来设置超时时间。如果由于未知原因(通常为临时网络中断) 导致自适应超时值太小而客户端处理 RPC超时，可增大at_min值。at max 自适应超时的最大值〈以秒为单位) ，是服务估计时间的上限。如FRIAS at_max，RPC 请求超时。将at_max 设置为0则表明茜用自适应超时，转而采用固定超时时间设置方法。注意，如果慢速硬件导致服务估计值增加直至超出默认值at_max，可将at_max增加300\nLustre 文件系统操作手册 译者: ZAR参数 说明到您愿意等待RPC 完成的最长时间。at_history 自适应超时记忆的发生最慢事件的时间段 〈以秒为单位) 。默认值为 600。at_early margin ， 超过该时间，Lustre 服务需将发送早期回复 〈以秒为单位) 。默认{ELA 5.at_extra FRA Ba ACI BE RB Ss INGA Te CLO) 。服务aS ALE RPC 还需花费多少时间，因此会要求一个固定的值，默认为30。该",
        "和 150-300s bin 中,最大的RPC 时间为 1。300-450s501\nLustre 文件系统操作手册 译者:bin 中，最大 RPC 时间为 33 秒。450-600s bin 中，最大RPC 时间为 2 秒。估计的服务时间则取这四条记录中的最大值〈在本例中为 33 秒) 。客户端OBD 也跟踩服务时间 〈由服务器报告)，如下例所示:1 # lctl get Param osc.*.timeouts2 last reply : 1193428639, OdOhOOm00s ago3 network : cur 1 worst 2 (at 1193427053, Od0h26m26s ago) 1 1 14 portal 6 : cur 33 worst 34 (at 1193427052, OdOh26m27s ago) 33 33 335 portal 28 : cur 1worst 1 (at 1193426141, Od0h41m38s ago) 1 1 16 portal 7 : cur 1 worst 1 (at 1193426141, Od0h41m38s ago) 1 0 1mh PN7 portal 17 : cur 1worst 1 (at 1193426177，0quh41mu2s ago) 1 0 0在此示例中，portal 6 (ost_ io服务入口) 显示了该入口报告的服务时间估计历史记录。服务需统计文件还显示了估计值的范围，包括 min, max, sum 和 sumsq。例如:1 # lctl get Param mdt.*.mdt.stats2 .。.。3 req timeout 6 samples [sec] 1 10 15 1054...39.5.2. 设置静态超时在未司用目适应超时时使用，Lustre 软件提供两组静态 (固定) 超时: LND 超时和Lustre 超时。”LND timeouts - LND 超时可确保网络中的点对氮通信在出现故障《〈如程序包丢失或连接新开) 时在有限时间内乞成。每个 LND 有单独的 LND 超时参数设置。设置S_LND标志记录 LND thy. ETA eI ATT EAS, tea Lustre 日志中",
        "为\"stale\"。Lustre 客户端定期癌指定的时间段内没有通信的服务需发送\"ping\"消县。文件系统中客户端和服务人逢之间的任何网络话动和 ping 的效用相同。服务如等竺客户端回复初始 AST〈锁取消请求) 的时间。对于OST，默认值为 20 秒;) 对于MDS，默认值为 6 秒。如果客户端回复 AST，服务货将给它一个正明的超时《客户问超时时间的一半)来刷新任何脏数据并释放锁。内部调试故阶钩。软认值为 0，表示不会触发或注入任何故隐。超时时触发 Lustre 调试日志的转储。歌认信为 0，表示不会触发Lustre 调试日志的转储。发生驱和逐时触发 Lustre 调试日志的转储。默认值 0，表示不会触发 Lustre 调试日志的转储。LNet 信息位于/proc/sysy/lnet 的以下文件中:303\nLustre 文件系统操作手册详这ay- peers - 显示此和氮已知的所有 NID ，并提供有关队列状态的信息。示例:1 # lctl get param peers2 nid refs state max rtr min tx min queue3 O@1Lo 1 ~rtr 0 0 0 0 0 04 192.168.10.35@tcp 1 ~rtr 8 8 8 8 6 05 192.168.10.36@tcp 1 ~rtr 8 8 8 8 6 06 192.168.10.37@tcp 1 ~rtr 8 8 8 8 6 0表中各条目含义如下 :KA 说明refs 引用计数。state 如果和点是路由器，则表示路由融的状态。对应值有: NA 一表示和点不是Bt airs up/down—fR NW Gitar) 是否为局动状态。max 此对等节点的最大并发发送数。ctr 路由缓冲区信用值。min 历史最低路由缓训区信用值。tx 发送信用值。queue 活动/排队中的发送总字布数。信用值被初始化以允许一定数量的操作〈如上方示例所示，max列为8)。LNet 跟踪了监控时间段内看到的最低信用值，以显示此时间段",
        "max rpcs in flight 参数定义了客户端并行发送到 MDT 目标的元数据 RPC 的最大数量，包括更改和不更改文件系统的RPC。这包含了所有文件系统元数据操作，如文件或目录统计、创建、取消链接等。其默认值为8，最小值为1，最大值为 256。在 Lustre 客户端上运行以下命令设置max rpcs in flight Bx:client$ lctl set param mdc.*.max tpcs in flight=16MDC ji) max_mod_rpes_in_flight 参数定义了客户端并行发送到 MDT 目标的更改文件系统的RPC 的最大数量。例如，Lustre 客户端在执行文件或目录创建、取消链接、访问权限修改、所有权修改时会发送更改式 RPC。其默认值为7，最小值为1，节KIBYA 256.在 Lustre 客户端上运行以下命令设置max mod _rpcs in flight BR:client$ lctl set param mdc.*.max_mod_rpcs in flight=12max mod rpcs in flignt值必须比max_ rpcs in flight 值小 同时也必须小于或等于MDT 的 max_mod_rpcs_per_client 值。如果未满足其中一个条件，设置将失败，并在 Lustre 日志中写入明确的错误消息。498\n1—23456101213141516171819Lustre 文件系统操作手册 译者:这ayMDT 的 max mod_rpcs per client参数是内核模块mdt的可调参数，它定义了每个客户问所允许的处理中的最大更改式 RPC 数量。该参数可以在运行时进行更新，但此更改仅对新客户端连授有效。其默认值为8。在 MDS 上运行以下命令设置max mod rpcs per client Bx:mds$ echo 12 > /sys/module/mdt/parameters/max mod_rpcs per client39.4.5.2. 客户端元数据 RPC PEGE rpc_stats 文件包含了显示更改式 RPC 相关信息的直方图，可用于确定应用程序执行更改文件系统的元数据操作时所实现的并行级sl).示例:client$ lctl get param mdc.*.rpc_ statssnapshot time:",
        "at_extra FRA Ba ACI BE RB Ss INGA Te CLO) 。服务aS ALE RPC 还需花费多少时间，因此会要求一个固定的值，默认为30。该默认值在发送过多早期回复和高估实际完成时间之间寻求了一个平衡。当服务需发现排队请求即将超时并需要发送早期回复时，服务器会加大at_extta值。如果超时，Lustre 服务器将丢弃请求，客户端进入恢复状态并重新连接到正少状态。如果同一 RPC发生了多个要求增加 30 秘的早期回复，请将at_extzra值更改为一个较大的数字以减少早期回复的发送，从而减少网络负载。1dlm_enqueue_min 最小锁入队时间《〈以秒为单位) ，默认值为 100。锁入队所需的时间1dqlm_endqueue通过入队估计所需时间的最大值〈受at_min和|at_max人参数影响) 乘以加权因子和1dlm_endqueue _ min计算所得。测量所得的入队时间增加时，锁入队的时间增加《类似于自适应超时)。395.11. 解析上自适应超时信息 目适应超时信息可在每个服务器上使用命令]ct1l get param {ost,mdqs}j.x.x.timeouts和在客户端上使用命令1Lct1lget param {oscrmqdqc}j.*.timeouts获取。从timeouts 中读取信息，请输入 :1 # lctl get Param -n ost.*.ost_io.timeouts2 service : cur 33 worst 34 (at 1193427052，0dqoh26m40s ago) 1 1 33 2在此示例中，此布点上的ost_io服务报告了 RPC 服务时间估计为 33 秒。最长的RPC 服务时间发生在 26 分钟前，为 34 秒。该输出还提供了服务时间的历史记录，显示了四个自适应超时历史记录，分别报告了其最大的RPC 时间。在0-1$0s bin 和 150-300s bin 中,最大的RPC 时间为 1。300-450s501\nLustre 文件系统操作手册 译者:bin 中，最大 RPC 时间为 33 秒。450-600s bin",
        "。queue 活动/排队中的发送总字布数。信用值被初始化以允许一定数量的操作〈如上方示例所示，max列为8)。LNet 跟踪了监控时间段内看到的最低信用值，以显示此时间段内的高峰拥挤。低的信用值表示资源更加拥挤。当前处理中的信用值 〈传输信用值) 显示在tx列中。可用的最大发送信用祝显示在max中，且永远不会发生变化。可供对等下氮使用的路由天缓冲区数量显示在ztt列中。因此，Ftz -七x是处理中的传输数目。尽管可以设置使nax>=ztz，通各情况下，rtr == max。路由绥补信用与发送信用之比 (rtz/x) 如果小于max表示操作正在进行中;如果大于max，则表示操作被阻止。LNet 还限制了并发发送和分配给单个对等节点的路由硕缓冲区数量，从而避免对等节氮占用所有资源。\"nis 一显示该站扣上队列当前健康状况。504\n这ayLustre 文件系统操作手册 译者:示例:# ctl get param nis nid refs peer maxtx min O@lo 3 0 0 0 0192.168.10.34@tcp 4 8 256 256 252表中条目的含义如下:条目 说明nid 网络接口。refs ， 内部引用数。peer ”此NID 上氮对点的发送信用数，用于调整缓冲池的大小。max 此 NID 的最大发送信用值。tx 此NID 当前可用的发送信用值。min 此NID 当前可用的最低信用值queue 活动/排队中的发送总字数。分析:(max - tx) 为当前活动的发送数量。活动发送量很大或越来越多则表示可能存在问题。39.7. 在 OST 上分配空闲空间可用空间分配使用循环法还是加权法，由OST 之间可用空间的不平衡状况决定。OST 之间的可用空间相对平衡时，使用更快的循环分配务。任何两个 OST 的可用空间兰别超过指定国值时，使用加权分配需可 以使用 以下两个可调参数调玫可用上 x间分布:。 lod.*.gos_threshold_rr 一在此文件中设置",
        "式 RPC 相关信息的直方图，可用于确定应用程序执行更改文件系统的元数据操作时所实现的并行级sl).示例:client$ lctl get param mdc.*.rpc_ statssnapshot time: 1441876896.567070 (secs.usecs)modify RPCs in flight: 0modifyrpcs in flight rpcs + Cum %0 : 0 0 01: 56 0 02 : 40 0 03: 70 0 04 41 0 05: 51 0 16: 88 0 17: 366 1 28: 1321 5 89: 3624 15 2310: 6482 27 5011: 7321 30 8112: 4540 18 100文件内容包括:。 snapshot time 一读取文件时的 UNIX epoch 瞬间。。 modify RPCs_in_ flight 一 MDC 发起但当前还未完成的更改式 RPC 数。该值必须永远小于或等于max mod rpcs in flight.。 rpcs in flight 一发送RPC 时当前挂起的更改式 RPC 数量，包括相对百分比(3) 和宗积百分比 (cum %).499\n—Lustre 文件系统操作手册 译者:这ayMW AR KR ub ay BE oe st 7c Bt ie RPC AE KRW CAA Ke INimax mod_rpcs_in flight值的挂起元数据RPC，则意味着可以增加max mod rpcs_ in flignt值来提高元数据更改性能。39.5. Lustre 文件系统超时配置在 Lustre 文件系统中，RPC 超时使用目适应超时机制〈默认为司用)。服务融跟踪RPC 完成时间并同和客户端报告，以便估计未来 RPC 的完成时间。客户问使用这些佑计值来设置 RPC 超时值。当服务货请求处理因某种原因而减慢时，服务硕 RPC 完成时间延长，客户端则随之修改 RPC 超时值以允许更多的时间来守成RPC。如宁服务郁上排队的 RPC 接近客户端指定的RPC 超时，为避免 RPC 超时和上断开和重新连接的循环，服务僚会癌客己端",
        "新开) 时在有限时间内乞成。每个 LND 有单独的 LND 超时参数设置。设置S_LND标志记录 LND thy. ETA eI ATT EAS, tea Lustre 日志中的D_NETERROR消轧，或使用以下命令将D_NETERROR消妃打印到控制人台 :lctl set param printk=+neterrorHAZE ESR i ar A) BE we LND 假性超时。为避免这种情况，请增加 LNet fe a are区的数量来减少背压，或增加网络上所有节点的LND 超时。同时，也可考虑增加系统中 LNet 路由器节点总数，从而使路由句总从宽与服务器总佛宽相匹配。。 Lustre timeouts 一在未启用上自适应超时时，Lustre 超时可确保了RPC 出现故障时在有限时间内完成。目适应超时默认为司用状态，要在运行时禁用上自适应超时，请在 MGS 上将at_max设置为0:502\nLustre 文件系统操作手册 译者:这ay# Ictl conf param fsname.sys.at_max=0注意在运行时更改目适应超时的状态可能会导致客户端和时的超时、恢复和重连。Lustre 超时的消息将始终打印在控制合上。如果 Lustre 超时未伴随 LND 超时，请增加服务磺和客户端上的 Lustre 超时时间。使用如下命令进行设置:# lctl set param timeout=30Lustre 超时参数 :We数timeoutldlm_ timeoutfail locdump on timeoutdump on eviction39.6. LNet 监控说明客户端等待服务需完成 RPC 的时间 〈软认为 100 秒) 。服务需等竺正明客户端完成了RPC 的时间为此时间的一半，等待单个批量请求〈最多读取或写入 4MB) 完成的时间为此时间的四分之一。客己问在超时时间的四分之一处 ping 可恢复目标 CMDS 和QOST)，服务需将等竺超时时间的一倍半再驱逐客户端、将其设置为\"stale\"。Lustre 客户端定期癌指定的时间段内没有通信的服务需发送\"ping\"消县。文件系统中客户端和服务人逢之间的任何网络话动和 ping 的效用相同。服务如等竺客户端回复初始",
        "cancel 功能〈黑认司用) WRIT 2 he Pi Be BS入对象的交叉区域后的 OSS 及其中一个客户端朋省时可能导致的数据不一致问题。当违反连续写入的 POSIX 要求并存在损坏数据的淤在风险时，将创建一个条件。局用sync-on-lock-cancel 后，如果取消的锁附加了任何满足此条件的不稳定的写入，则 OSS 会在锁取消时将日志同步导入磁姓。因此，尽管禁用sync-on-Iock-cance1l功能可以提升并发写入工作负载的性能，我们仍建议您不要蔡用此功能。497\n—Lustre 文件系统操作手册这aysync_on lock _cancel1人参数可设置为以下值: :。 always 一在锁取消时强制执行日志更新 (async_journal司用时的默认值)。\"blocking一只在因阻塞回调引起的锁取消时强制执行日志更新。\"nevet 一不强制执行任何日志更新 〈async_journal华用时的默认值)。例如，将 sync_on_lock_cancel 设置为不强制执行日志更新，使用以下类似命4S:$ lctl get_param obdfilter.*.sync_on lock cancel2 obdfilter.lol-OST0001.sync on lock cancel=never——39.4.5. 客户端元数据 RPC 流的调试客户端元数据RPC 流表示客户端并行发起的到MDT 目标的元数据RPC。元数据RPC 可以分为两类: 不更改文件系统的请求〈如 getattr 操作) 和更改文件系统的请求(如 create、unlink、setattr 操作) 。为优化客户端元数据RPC iit, Lustre 提供了几个可调参数来根据网络条件和集群大小调整行为。请注意，增加并行发起的元数据RPC 的数量可能会改善元数据密集型并行应用程序的性能，但会在客户端和 MDS 上消耗更多的内存。(在 Lustre 2.8 中引入)39.4.S.1. 配置客户端元数据RPC流 MDC AY max rpcs in flight 参数定义了客户端并行发送到 MDT 目标的元数据 RPC 的最大数量，包括更改和不更改文件系统的RPC。这包含了所有文件系统元数据操作，如文件或目录"
    ]
}