{
    "query": "请简述 Lustre 文件系统中创建快照以确保文件系统一致性的方法。",
    "summaries": [
        "Lustre 文件系统支持快照功能，用于创建文件系统的一致性副本。快照可以通过命令 `lctl snapshot create` 创建，并可使用 `-b` 选项自动触发全局写屏障以确保一致性。全局写屏障通过 `lctl barrier freeze` 命令添加，防止元数据修改，保证快照的一致性。屏障可通过 `lctl barrier thaw` 移除，或在超时后自动过期。用户可通过 `lctl barrier stat` 查询屏障状态和剩余时间。快照日志记录在 `/var/log/lsnapshot.log` 中，包含快照创建、挂载、销毁等信息。此外，Lustre 还提供配置日志功能，通过 `lctl fork lcfg` 和 `lctl erase lcfg` 操作，用于管理快照的配置信息。",
        "创建了两个LVM卷MDTO和OSTO，用于Lustre文件系统。格式化MDTO为MDT，OSTO为OST，并挂载到/mnt/mdt和/mnt/ost。定期将新文件备份到main文件系统。创建LVM快照卷MDTO.b1和OSTO.b1用于备份。快照生成后继续备份文件到main，快照不包含新文件。从快照恢复文件系统需重命名快照并使用tunefs.lustre命令。",
        "本文档介绍了Lustre文件系统中快照的操作方法，包括创建、删除、挂载、卸载、列出和修改快照属性。快照可通过MGS上的lctl命令进行管理，创建时可设置写屏障和注释，删除时可选择强制删除，挂载需使用只读选项，卸载需在客户端执行，列出快照可显示详细信息，修改快照属性包括注释和名称。所有操作均需指定文件系统名和快照名，并支持远程通信。"
    ],
    "contents": [
        "没有运行。示例如下:cfs21:~# modprobe dm-snapshotcfs21:~# lvcreate -L50M -s -n MDTO.b1 /dev/vgmain/MDTORounding up size to full physical extent 52.00 MBLogical volume \"MDTO.b1\" createdcfs21:~# lvcreate -L50M -s -n OSTO.b1 /dev/vgmain/OSTORounding up size to full physical extent 52.00 MBLogical volume \"OSTO.b1\" created189\nLustre 文件系统操作手册 译者:这ay快照生成后，您可以继续备份新的或更改后的文件至\"main\"。快照不会包含这些新文件。1 cfs21:~# cp /etc/termcap /mnt/main2 cfs21:~# ls /mnt/main3 fstab passwd termcap18.5.4. 从快照恢复文件系统清参照以下程序从 LVM 快照恢复文件系统。1. 重命名 LVM 快照。将文件系统快照从\"main'\" 重命名为\"back\"，以便在不印载\"main\" 的情况下挂载\"back\"'。该操作不是必需的《虽然我们推荐这么做) ，可通过设置tunefs. Lustre 的--reformat 标志来强制名称更改。例如:1 cfs21:~# tunefs.lustre --reformat --fsname=back --writeconf/dev/vgmain/MDTO.b12 checking for existing Lustre data3 found Lustre data4 Reading CONFIGS/mountdata5 Read previous values:6 Target: main-MDTO00007 Index: 08 Lustre FS: main9 Mount type: ldiskfs10 Flags: Ox511 (MDT MGS )12 Persistent mount opts: errors=remount-ro,1open nopriv,user xattr13 Parameters:14 Permanent disk data:15 Target: back-+MDT000016 Index: 017 Lustre FS: back18 Mount type: ldiskfs19 Flags: Ox10520 (MDT MGS writeconf )21 Persistent mount opts: errors=remount-ro,1open nopriv,user xattr190\n2527282930313233343536383940414243444546Lustre 文件系统操作手册 译者:这ayParameters:Writing CONFIGS/mountdatacfs21:~# tunefs",
        "--rsh remote shell]选项”说明=-C 更新快照注释-F 文件系统名354\nLustre 文件系统操作手册这aX选项说明-h 帮助信息-n 快照名-N 重新命名快照为 new_ssname-zz ”用于与远程目标进行通信的远程外这。黑认值是'ssh 。31.4. 全局写屏障快照在多个MDT 和 OST 上是非原子型的，这意味着如果创建快照时文件系统上存在活动，则在 MDT 快照和 OST 快照之间的时间间隔中创建或销毁的文件可能存在用户可见的名称空间不一致问题。为保证文件系统快照的一致性，我们可以设置全局写屏障或将系统\" 冻结\"。完成该设置后，所有元数据修改在写屏障被主动移除 (\" 解冻\") 或过期前都将被阻止。用户可以为该全局屏障设置超时参数，或明确地删除屏障。超时时间默认为 30 #请注意，即使没有设置全局屏障，快照仍可用。如果不使用屏障，当前客户端正在修改的文件〈写入、创建、取消链接) 可能存在如上所述的不一致情况，其他未修改的文件可以正常使用。使用1ct1 snapshot create及-b选项请求创建快照，将在内部调用写屏障。因此，使用快照时不需要明确使用屏了区，但在创建快照之前请包含该选项。31.4.1. 添加屏障要添加全局写屏障，请在 MGS 上运行1ct1 barrier freeze人命令:1 lctl barrier freeze <fsname> [timeout (in seconds) ]2 where timeout default is 30.将文件系统 testfs URZH 15 秒:1 mgs# lctl barrier freeze testfs 15ame One CRA, AMUPRHET HFS ETA31.4.2. Be RE移除全局写屏障，请在 MGS 上运行LIct1 barrier thaw命令:1 lctl barrier thaw <fsname>为文件系统 es大 解冻:355\nLustre 文件系统操作手册 译者:这ay1 mgs# lctl barrier thaw testfsame One CRA, AMUPRHET HFS ETA31.4.3. 查询屏障查看全局写障碍剩余时间，请在 MGS",
        "# lvcreate -L200G -nMDTO vgmainLogical volume \"MDTO\" createdcfs21:~# lvcreate -L200G -nOSTO vgmainLogical volume \"OSTO\" createdcfs21:~# lvscanACTIVE '/dev/vgmain/MDTO' [200.00 GB] inheritACTIVE '/dev/vgmain/OSTO' [200.00 GB] inherit2. 格式化 LVM 卷为目标 Lustre.在这个例子中，备份文件系统为main ，指代当前的最新的备份。187\n1012131415161718192021222324252627282930313233343536Lustre 文件系统操作手册 译者:这aycfs21:~# mkfs.lustre --fsname=main --mdt --index=0 /dev/vgmain/MDTONo management node specified, adding MGS to this MDT.Permanent disk data:Target: main-MDTO0000Index: 0Lustre FS: mainMount type: ldiskfsFlags: 0x75(MDT MGS first time update )Persistent mount opts: errors=remount-ro,1open nopriv,user xattrParameters:checking for existing Lustre datadevice size = 200GBformatting backing filesystem ldiskfs on /dev/vgmain/MDTOtarget name main-MDTOO004k blocks 0options -1 4096 -I 512 -q -O dir index -Fmkfs cmd = mkfs.ext2 -j -b 4096 -L main MDTO000 -1i 4096 -I 512 -q-O dir index -F /dev/vgmain/MDTOWriting CONFIGS/mountdatacfs21:~# mkfs.lustre --mgsnode=cfs21 --fsname=main --ost --index=0/dev/vgmain/OSTOPermanent disk data:Target: main-OSTO000Index: 0Lustre FS: mainMount type: ldiskfsFlags: 0x72(OST first time update )Persistent mount opts: errors=remount-ro, extents,mballocParameters: mgsnode=192.168.0.21@tcpchecking for existing Lustre datadevice size = 200GBformatting backing filesystem ldiskfs on /dev/vgmain/OSTOtarget name main-OSTOO0004k blocks 0188\n3738394041424344—ULDNn—Nn67Lustre 文件系统操作手册%ty这ayoptions -I 256 -q -",
        "200GBformatting backing filesystem ldiskfs on /dev/vgmain/OSTOtarget name main-OSTOO0004k blocks 0188\n3738394041424344—ULDNn—Nn67Lustre 文件系统操作手册%ty这ayoptions -I 256 -q -O dir index -Fmkfs cmd = mkfs.ext2 -j -b 4096 -L lustre-OSTO000 -J size=400 -I 256-1 262144 -O extents, uninit bg,dir nlink,huge file,flex bg -G 256-E resize=4290772992,lazy journal init, -FE /dev/vgmain/OSTOWriting CONFIGS/mountdatacfs21:~# mount -t lustre /dev/vgmain/MDTO /mnt/mdtcfs21:~# mount -t lustre /dev/vgmain/OSTO /mnt/ostcfs21:~# mount -t lustre cfs21:/main /mnt/main18.5.2. 备份新的/更改后的文件定期 〈如每晚) 将新文件和更改后的文件备份到基于 LVM 的备份文件系统。cfs21:~# cp /etc/passwd /mnt/maincfs21:~# cp /etc/fstab /mnt/maincfs21:~# ls /mnt/mainfstab passwd18.5.3. 创建快照卷无论何时您想要创建主要 Lustre 文件系统的\" 检查氮\"，都可以在基于 LVM 的备份文件系统中创建所有目标 MDT 和 OST 的 LVM 快照。您必须事先决定快照的最大大小，但可以稍后进行动态更改。每日快照的大小取雇于主要 Lustre 文件系统中每日发生变更的数据量。两天的快照很可能会是一天快照的两倍。如卷组中有空间，可创建尽可能多的快照。如有必要，可动态地将磁盘添加到卷组。目标MDT 和 OST 的快照应在同一时间氮生成。更新备份文件系统的 cronjob 是唯一写入人磁盘的东西，请确保它没有运行。示例如下:cfs21:~# modprobe dm-snapshotcfs21:~# lvcreate -L50M -s -n MDTO.b1 /dev/vgmain/MDTORounding up size to full",
        "Bl ct Lar4S:1 lctl snapshot umount [-F | --fsname fsname] [-h | -—help]2<-n | -- name ssname> [-r | --rsh remote shell]选项”说明-F 文件系统名-h 帮助信息一 快照名333\n这aXLustre 文件系统操作于册 译者:选项 说明-zz ”用于与远程目标进行通信的远程外这。黑认值是'ssh 。例如:1 lctl snapshot_umount -F myfs -n Snapshot 2017060231.3.5. 列出快照列出给定文件系统的可用快照，请在 MGS 上运行以下1ct1命令1 lctl Snapshot Jist [-d | --detail] <-F | --fsname fsname>2 [-h | -- help] [-n | --name ssname] [-r | --rsh remote shell]选项 ”说明-d ，列出指定快照的各部分-FF 文件系统名-h 帮助信息—n ， 快照名。如果没有提供快照名，将显示此文件系统的所有快照。-用于与远程目标进行通信的远程外壳。默认值是ssh 。31.3.6. 修改快照属性Lustre 快照目前有五个用户可见属性: 快照名称、快照注释、创建时间、修改时间和快照文件系统名称。其中，前两个属性可以修改。重命名遵循通用的 ZFS 快照名称规则，如最大长度为 256 字和、不能与预留名称冲突等等。要修改快照的属性，请在 MGS 上运行以下1ct1命令:1 lctl snapshot_modify [-c | --comment comment]2 <-F | --fsname fsname> [-h | --help] <-n | --name ssname>3 [-N | --new new ssname] [-r | --rsh remote shell]选项”说明=-C 更新快照注释-F 文件系统名354\nLustre 文件系统操作手册这aX选项说明-h 帮助信息-n 快照名-N 重新命名快照为",
        "- myfs-MDTO000 zfs: /tmp/myfs—mdt1/mdt1host-mdt2 - myfs-MDTO001 zfs:myfs-mdt2/mdt2host-ostl - OSTOO000 zfs:/tmp/myfs-ostl1/ostlhost-ost2 - OSTO001 zfs:myfs-ost2/ost2配置文件是手动编辑的。当配置文件更新为当前最新的文件系统设置，您可以开始创建文件系统快照。31.3. 快照操作31.3.1. 创建快照创建现有 Lustre 文件系统的快照，在 MGS 上运行以下 lctl 命令:lctl snapshot_create [-b | --barrier [on | off]] [-c | --commentcomment] -FE | --fsname fsname> [-h | --help] -n | --name ssname>[-r | --rsh remote shell] [-t | --timeout timeout]选项 说明-b 在创建快照乙前设置写屏障。默认值是on'。-c 人快照目的说明-F 文件系统名\nLustre 文件系统操作于册 译者:这ay选项 说明-hn 帮助信息-0 快照名-c 用于与远程目标进行通信的远程外帝。黑认值是'ssh 。-+ ， ，写屏隐的时间周期。默认值是 30 秒。31.3.2. 删除快照删除现有 snapshot，在 MGS 上运行 Lct1l 命令1 lctl snapshot destroy [-f | --force] <-F | --fsname fsname>2 <-n | --name ssname> [-r | --rsh remote shell]选项 ”说明-£ 暴力销毁快照-FE 文件系统名-h 帮助信息-nn 快照名-c 用于与远程目标进行通信的远程外帝。黑认值是'ssh 。31.3.3. 挂载快昭快照被视为单独的文件系统，可以在 Lustre 客户端上挂载，但必须使用-o Fo选项将快照文件系统挂载为只读文件系统。如果mount选项不包含该只读选项，将导致挂载失败。注意在客户端上挂载快照之前，必须使用 1ct1l 工具将先在服务器上挂载快照。",
        "/1Llog/Lsnapshot.1og中找到。该文件包含了快照创建和挂载、属性更改的时间信息，以及其他快照相关信息。以下是 /var/log/1snapshot 文件的样本:Mon Mar 21 19:43:06 2016(15826:jt_ snapshot _create:1138:scratch:ssh): Create snapshot lss 0 0successfully with comment <(null)>, barrier <enable&, timeout <30>Mon Mar 21 19:43:11 2016 (13030:jt snapshot create:1138:scratch:ssh) :Create snapshot lss 0 1 successfully with comment <(null)>, barrier<disable, timeout <-1>Mon Mar 21 19:44:38 2016 (17161:jt_snapshot_mount:2013:scratch:ssh) :The snapshot lss la 0 is mountedMon Mar 21 19:44:46 2016(17662:jt_ snapshot _umount:2167:scratch:ssh): the snapshot lss la 0have been umountedMon Mar 21 19:47:12 2016(20897:jt snapshot destroy:1312:scratch:ssh): Destroy snapshotlss 2 0 successfully with force <disable31.6. Lustre 配置日志快照独立于其原始文件系统，被视为可由 Lustre 客户端节点挂载的新文件系统名。文件系统名是配置日志名的一部分，存在于配置日志条目中。有两个用于操作配置日志的命令: lctl fork lcfg和1Lct1l erase lcfg.快照命令将在需要时内部调用配置日志功能。因此，使用快照时，屏隐不是必需的，而是作为一个选项包含在这里。以下配置日志命令独立于快照，可单独使用。分配配置日志，请在 MGS 上运行以下1Lct1命令:letl fork lcfg357\nLustre 文件系统操作手册 译者:这ay用例: fork Icfg控除配置日志，请在 MGS 上运行以下1Lct1命邻:1 lctl erase lcfg用例: erase lcfg第三十二章 Lustre 网络性能测试 LNet self-test)32.1. LNet 自检概述它",
        "使用-o Fo选项将快照文件系统挂载为只读文件系统。如果mount选项不包含该只读选项，将导致挂载失败。注意在客户端上挂载快照之前，必须使用 1ct1l 工具将先在服务器上挂载快照。CEMA as LEER, TE MGS 上运行 lctl 命令:1 lctl snapshot mount <-F | --fsname fsname> [-h | —-help]2 <-n | --name ssname> [-r | --rsh remote shell]352\nLustre 文件系统操作手册 译者:这ay选项 说明-F 文件系统名-hn 帮助信息-0 快照名-zz ”用于与远程目标进行通信的远程外这。黑认值是'ssh 。成功在服务釉上挂载快照后，客户端便可以将快照挂载为只读文件系统。例如，要为名为 myfs 的文件系统装入名为 snapshot_20170602 的快照，使用以下挂载命令:1 mgs# lctl Snapshot mount -F myfs -n Snapshot 20170602服务硕上的快照挂载完成后，使用 lctl snapshot_ 1ist返回快照的文件系统名:1 ss_fsname=$ (lctl snapshot list -F myfs -n Snapshot 20170602 |2 awk '/*snapshot fsname/ { print $2 }')最后，在客户端上挂载快照:1 mount -t lustre -o ro SMGS nid:/Sss_fsname $local_ mount point31.3.4. SER ARBMRA ar BEC ERER, ERIC FEAE TP ht EE PE umount an MA Pi生载快照文件系统。例如，要印载名为 snapshot_20170602 的快照文件系统，请在所有直载了它的客尸病上运行以下命令:1 client# umount $local mount pointPAP hin ROCHE ARSC BUA, TERE ARS ae EIB TT A Bl ct Lar4S:1 lctl snapshot umount [-F | --fsname fsname] [-h | -—help]2<-n | -- name ssname>",
        "355\nLustre 文件系统操作手册 译者:这ay1 mgs# lctl barrier thaw testfsame One CRA, AMUPRHET HFS ETA31.4.3. 查询屏障查看全局写障碍剩余时间，请在 MGS 上运行1ct1 barrier _ stat命令:1 # lctl barrier stat <fsname查询文件系统 tests 的写屏障统计信息:1 mgs# lctl barrier stat testfs2 The barrier for testfs is in 'frozen'3 The barrier will be expired after 7 secondsmS KDA TU aT OP PN IST aS, UU aT Fa DELS写屏障可能存在的状态和相关合义如下表所示:init 该系统上未曾设置屏障freezing pl 设置写屏障的第一阶段freezing p2 设置写屏障的第二阶段frozen 已成功设置写屏障thawing 写屏障\" 解冻\"thawed 写屏障已\" 解冻\"failed 设置写屏障失败expired 写屏障超时rescan MDTs (KASH, Ub barrier rescanunknown 其他情况如果屏隐处于'ffreezing_ pl、'ffeezing _p2 ak'frozen' 状态，将返回写屏障剩余的时间。31.4.4. 重新扫描屏障要重新扫描全局写屏障以检查哪些 MDT 处于活动状态，请在 MGS 上运行1ct1barrier rescan命令:1 lctl barrier rescan <fsname> [timeout (in seconds) ] ，356\nLustre 文件系统操作于册 译者:这ay2 where the default timeout is 30 seconds.——ULD121314—Hp Tai FARA tesefs HS He:mgs# lctl barrier rescan testfs1 of 4 MDT(s) in the filesystem testfs are inactive如果该命令成功，将输出总 MDT 数量及不可用的 MDT 2car. ATV, RTH FaeIAI.31.5. 快照日志所有快照活动的日志可以在文件 /var/1Llog/Lsnapshot.1og中找到。该文件包含了快照创建和挂载、属性更改的时间信息，以及其他快照相关信息。以下是 /var/log/1snapshot 文件的样本:Mon Mar 21 19"
    ]
}