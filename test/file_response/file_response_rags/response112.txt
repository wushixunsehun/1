{
    "query": "某 Lustre 集群需优化故障恢复效率，管理员计划启用祈使式恢复（Imperative Recovery）机制，并调整恢复窗口以缩短客户端重连时间。需要配置哪些参数？",
    "summaries": [
        "Lustre调试日志的显示条目由掩码控制，支持多种标志，可通过加+或-来添加或删除标志。Imperative Recovery参数用于设置恢复窗口，通过factor调整超时时间，提高系统可用性。直通式写缓存可提升读取性能，适用于特定场景，设置方法涉及不同组件的参数配置。",
        "Lustre 文件系统操作手册摘要：本文介绍了请求历史记录的管理方法，包括请求缓冲区的添加、删除和控制参数。还描述了使用 leak_finder.pl 程序查找内存泄漏的步骤。此外，讨论了 Lustre 的系统恢复功能，涵盖客户端故障、驱逐、MDS 故障及高可用性机制，强调在故障发生时保持集群一致性和高效性的策略。",
        "Lustre 文件系统通过事务编号（XID）对客户端请求进行排序和唯一标识，确保文件系统操作的顺序性和可恢复性。每个涉及状态更改的请求都会被分配一个单调递增的 64 位事务编号，用于恢复时重新执行操作。服务端在故障后通过重放（replay）和重发（resend）机制恢复客户端请求，重放用于已收到成功回复的操作，重发用于未收到回复的操作。客户端维护重放列表，保存可能需要重放的请求，并在连接恢复后按事务编号顺序重放。服务器在恢复模式下等待客户端重新连接，收集信息以完成恢复过程。若重放序列中出现间隙，可能是由于回复丢失，客户端需在重发列表中保留相关请求以确保恢复完整。"
    ],
    "contents": [
        "。每个客户端会报告最近一次的事务，以便服务器获知何时所有事务完成重放。客户端还会报告先前等竺请求完成的时间，用于帮助服务器估计某些客户端可能需要多长时间来检测服务吉故障并重新连接。如果客户端在重放期间超时，则会尝试重新连接。如果客户端无法重新连接，则REPLAY和失败并返回DISCON状态。客户端可能会在REPLAY期间频每地超时，因此重新连接不应该使已经很慢的进程延展过久。我们可以通过在重放期间增加超时时间来绥解这种情况。38.2.6. 请求重放如果客户端先前已连接，则会从服务万获得响应，得知服务器正在进行恢复，并获知人磁盘上最后提交的事务编导。然后，洛户端便可以过历其重放列表并使用此最后提交的事务编号来删除任何先前提交的请求。它按照事务编号的顺序回服务需重放任何较新465\nLustre 文件系统操作于册 译痢:As大的请求，一次一个，收到服务融的回复后再重放下一个请求。重放列表上的\" 打开请求\" 的事务编号可能小于服务硕上次提交事务的编号。服务骨将立即处理这些打开请求，然后再按照事务编号顺序处理来自客户端的重放请求。从最后提交事务的编号开始，确保状态在磁盘上以与故障之前完全相同的方式更新。在处理每个重放请求时，最后提交的事务编号将递增。如果服务货从客户端收到大于当前的最后提交事务编号的重放请求，则该请求会被搁置，直到其他客户端发起干预事务。服务般以这种方式按照驳前在服务郁上执行的相同顺序重放请求，直到所有客户端无请求可重放或序列中存在间隐。38.2.7. 重放序列中的间隙在菜些情况下，回复序列中可能会出现间陀。这可能是回复丢失引起的，即请求已处理并提交到人磁盘，但客户端未收到回复; 也可能是由于部分网络必障或客户端朋误导致回复无法发送至客户端造成的。在所有客户端都已重靳连接但重放序列仍存在间隐的情况下，唯一的可能是服务融处理了一些请求但是回复丢失了。客户站必须在其重发列表中包含这些请求，以便恢复宛成后进行重发。如有果所有客户端都未重新连接，则故隐客户端可能有",
        "vars: 80)ULDfreed 8bytes at a3116744 (called pathcopy)&(lprocfs status.c:lprocfs add vars: 80)发现的泄漏显示如下:—Leak: 32bytes allocated at a23a8fc(service.c:ptlrpc init svc:144,debug fileline 241)第三十八章 Lustre 文件系统恢复38.1. 概述Lustre 软件提供的系统恢复功能负责处理节氮或网络故区，并将集群恢复到一致、高效的状态。由于 Lustre 软件允许服务大对人磁盘上文件系统执行异步更新操作《〈即服务船可以不等待更新同步提交到磁盘就进行回复)，因此可能存在客户端内存中的状态比毅法后服务融可从磁盘恢复的状态还新的情况。以下几种不同类型的故障可能导致恢复操作:。 Pin CREST A) 故障。 MDS 故障〈切换)。OST 故障 CHIH)。了瞬态网络分区460\nLustre 文件系统操作手册 译mKAs大对于 Lustre 来说，Lustre 文件系统故障和恢复操作都基于连接失败的概念; 即给定连接相关的任何读写失败即视为失败。强制恢复功能《在第 6 节中介绍) ，该功能使MGS 能够在目标从故障、故隐转移或其他中断恢复并重局时主动通知客户端。有关 Lustre 文件系统恢复的相关信息，请参见本章第 2 节\" 元数据重放\"。从损坏的文件系统中恢复的相关内容请参见本章第 3.5 节\" 提交共享\"。有关命令性恢复的信息，请参见本章第 6 5\" 强制恢复\"。38.1.1. 客户端故障Lustre 文件系统中的客户端故障恢复基于锁定撤销和其他资源，因此幸存的客户端可以不间断地继续工作。如果客户端未能及时响应分布式锁管理器 (DLM) 的阻塞锁回调或在很长一段时间都未能内与服务器通信 CAD ping 无回复) ，则会将客户端从群集中强制删除 (被驱逐)。这使得其他客户端可以获取该死亡客户端锁所阻止的锁，与该客户端关联的资源〈文件句柄，导出数据) 也将被释放。请注意，此状况可能是由网络分或客户端节点系统故障引起的。第 1.5 节\" 网络分区\" 对这种",
        "当缓冲区填满时，最早的日志记录会被丢弃。本参数控制了Lustre调试日志中的会出现哪些条目。下列掩码可以在该参数中使用:trace, inode, super, tty, malloc, cache, info, ioctl, neterror, net, warning, buffs,other, dentry, nettrace, page, dlmtrace, error, emerg, ha, rpctrace, vfstrace, reada,mmap, config, console, quota, sec, lfsck, hsm, snapshot, layout.如需在已设置的标志上添加新的标志，请在每个标志前加一个+ 。要删除单个标志，在它们前面加上 - 。78.2 设置方法将Lustre客户端或服务器的 debug 设置为{{ mask }} 。作者: 李希 更新时间: 2023年6月7日\nLustre 可调参数全解83. imperative_recovery factor: 设置祈使式恢复的恢复窗口83.1 简介本参数用来设置祈使式恢复 (Imperactive Recovery) 的恢复窗口。大规模Lustre文件系统在其生命周期中难免遇到服务器硬件故障等问题。在发生这种故障后，服务能够及时恢复显得尤为重要。高可用软件可自动将存储目标服务转移到备份服务器上。客户端可以通过RPC超时来检测服务器故障的出现，而RPC超时时间必须随着系统规模的扩大而进行调整，以防止在负载较大的情况下错误地判定服务器死亡。祈使式恢复 (Imperactive Recovery) 的目的是，通过主动告知客户端服务器发生了故障，来缩短恢复窗口，并由此最大限度地减少目标停机时间，从而提高整个系统的可用性。祈使式恢复并没有履盖以前的恢复机制，当祈使式恢复局用时，仍然可以在集群中进行基于客户端超时的恢复，为每个客户端仍然可以独立地从目标上上断开和重新连接。在支持祈使式恢复的客户端和不支持祈使式恢复的客户端混合连接到O9T或MDT的情况下，祈使式恢复不能缩短服务器的恢复超时窗口，因为不能确保所有客户端都及时收到了服务器重新局动的通知。即使在这样的混合环境中，完成恢复的时间也可能缩短，因为支持祈使式恢复的客户端仍然会接到通知，及时",
        "收到了请求，但在发送故障前无法回复或提交到磁窟。464\nLustre 文件系统操作手册 译者:As大38.2.4. 客户端重放列表在服务融发生故障的情况下，进行服务种状态恢复〈重放) 可能需要所有文件系统修改请求。所收到的来目服务融的包含比最后提交的事务编号更大的事务标号的回复将被保留重放列表中，每个服务天都有一个这样的重必列表。也就是说，当从服务需接收到回复时，检查它是否具有比先前的最后提交的事务编号还大的事务编号。大多数具有较小事务编号的请求可以安全地从重放列表中删除。请注意，\" 打开请求\" 在这里是一个例外，它需要保存在重放列表中直到文件关闭，以便 MDS 可以正确引用 open-unlinked文件的计数。38.2.5. 服务器恢复如果服务器未完全关闭，则会进入恢复状态。服务器启动时，如果先前连接的客户端在last_rcvq文件中有任何客户端条目，则服务器进入恢复模式，等待这些客户端重新连接并开始重放或重发其请求。这将允许服务吉重建已暴露给客户端 〈成功完成的请求) 但在故障前未提交到磁盘的状态。不进行任何客户端连接尝试的情况下，服务器将无限期地等待客户端重新连接。这旨在处理服务器存在网络问题时客户端无法重连或需要反复重启服务器来解决硬件或软件问题的情况。一旦服务器检测到客户端的连接尝试〈新客户端或先前连接的客户端) ，无论先前连接的客户端是否可用，恢复计时器都将启动并强制在有限时间内完成恢复。如果Last_rcvq文件中没有客户端条目，或管理员手动中止恢复，则服务器不会等待客户端重新连接，而是允许所有客户端进行连接。当客户端连接时，服务器从每个连接处收集信息以确定需要多长时间来完成恢复。每个客户端将报告其连接 UUID ，服务器在last_zrcvdq文件中碍找此 UUID 来确定此客户端之前是否已连接。如果没有，将拒绝此客户端的连接直到恢复完成。每个客户端会报告最近一次的事务，以便服务器获知何时所有事务完成重放。客户端还会报告先前等竺请求完成的时间，用于帮助服务器估计某些客户端可能需要多长时间来检测服务吉故障并重新连接。如果客户端",
        "窗口通过以下方式计算;新的超时时长 = recovery time * factor / 10factor 必须是一个在 [1，101] 范围内的值，默认值是5 。值为 8 的 factor 表示把强制恢复超时设置为目标上正常恢复超时的 80gs 。83.2 设置方法将所有OST的 obdfilter.{{ service name }}.ir _ factor 设置为{{ factor }};将所有MDT的 mdt.{{ service name }}.ir factor 设置为{{ factor }};将MGS的mdqt.{{ filesystem.fsname }}-MDT*.ir factor 5 obdfilter.{{ filesystem.fsname }}-OST*.ir factor 设置为{{ factor }} 。作者: 李希 更新时间: 2023年6月7日\nLustre 可调参数全解如果本参数打开，作为写请求发送到OSss的数据，会保留在读缓存中，供后续的读取使用; 否则，在与请求完成后，数据会从缓存中丢和寞。默认情况下，直通式与缓存的功能是启用的。当OSs收到来自客户端的写请求时，会从客户端接收数据，存在内存中，并写入磁盘。如果司用了直通式写缓存，在写请求完成后，这些数据在内存中留存，如果后续收到对相同数据的读请求，或者修改其中部分页面的写请求，OS5可以不用从磁盘读取这些数据。如果直通式与缓存被茶用，OSSs会在客户端的写请求完成后丢奔这些数据。对于后续的读请求或部分页的写请求，OSSs必须从磁盘重新读取数据。当客户端正在执行小数据写入或会导致部分页面更新的未对齐写入，或者其他节点需要立即读取另一个节点刚写入的文件时，建议启用与缓存。例如，在生产者-消费者MO模型中，或者在未进行4096字节边界对齐的共享文件写入等情况下，局用与缓存可能会非常有用。相反，当大部分MO为文件写入且在短时间内不会被重新读取，或者文件仅由同一节点写入和重新读取时，无论/O是否对齐，都建议共用与缓存。91.2 设置方法将所有MDT和",
        "诡加新请求至服务的请求历史记录。2. 请求缓冲区空时，添加服务请求组神区历史列表至缓冲区。3. 如宋缓冲区大小比*eq_buffer_history_max还大时，则从服务请求缓冲区历史记录中剔除该绥冲区，其请求从服务请求历史记录中删除。使用服务目录下/proc文件访问和控制请求历史记录:* req buffer history len历史记录中当前的请求缓冲区的数量。* req buffer history max人允许保留的请求缓冲区的最大大小。* req history请求历史。历史请求包括当前正在处理的\" 实时\" 请求。req_history 中的每一行看起来如下所示:1 Secuence:target NID:client NID:cliet xid:request_length:rpc Phaseservice specific data参数 说明seq 请求序列号target NID 传人请求的目的 NIDClient ID 客户端的PEID 和NIDxXid rq xidlength 请求消息大小phase 新〈等待处理或无法解压) 解析〈解压或处理) 完成sve specific 特定服务的请求打印输出。目前，唯一能做到这一点的服务是 OST(如采消息已成功解压，将打印操作码)439\nLustre 文件系统操作手册 译者:这ay37.3.3. 使用 leak finder .P1查找内存泄漏分配内存后，一旦不再需要时儿须杰放内存，和否则将造成内存洒漏。leak_findqer.p1程序提供了一种碍找内存泄漏的方法。在运行此程序之前，您必须局用调试功能以收集所有malloc和free条目，运行:—lctl set param debug=tmalloc随后，宛成以下步桑:1. 使用1ct1将日志转储到用户指定的日志文件中〈请参见本章第 2.2 站\" 使用 lctl 工具碍看调试消息\")。2. 在新创建的日志转储上运行1eak_finder.pP1l:perl leak finder.pl ascii-logname输出为:malloced 8bytes at a3116744 (called pathcopy)—N(lprocfs status.c:lprocfs add vars: 80)ULDfreed 8bytes at a3116744 (called pathcopy)&(lprocfs status.c:lprocfs add vars: 80)发现的泄漏显示如下:—Leak: 32bytes allocated at",
        "，与该客户端关联的资源〈文件句柄，导出数据) 也将被释放。请注意，此状况可能是由网络分或客户端节点系统故障引起的。第 1.5 节\" 网络分区\" 对这种情况进行了更详细的描述。38.1.2. 客户端驱逐如采服务锅认为某客户端表现不正前，饭将被逐出。这是为了确保在存在行为不当或改障客户端时整个文件系统继续运行。必须使被驱逐的客户冰的所有锁无效，这将导致所有缓存 pode 也变为无效，所有绥存的数据都将被刷新。客户端被驱逐的原因可能© ACHE BCH Mal py AR 5 er tg Hk© BAAS BTELDa] CBM Pande 3 — 1 Mira AR AS oe ALS A) BS)© Hise alah Da] CBP in Wee YB Ea PP a AT BY BE)° 锁 glimpse |B] yal (BU 7 mea — Te Pi IAT ARK)。 服务大关闭通知〈简化的互操作性)“在服务需接收到 RPC 流量时，无法及时 ping 通服务贫〈指同网络分区) 。38.1.3. MDS 故障 (HA)高可用性 CHA) 的 Lustre sO/F ACERT EORTC Bia AR A ie A Be HRC A设备，包括用于 MDT Ja CF ARES ie OSE IC RM. YS IT461\nLustre 文件系统操作手册 译者:As大电 〈STONITH，用于防止其继续修改共享磁盘) DR ee i AE Lustre MDS 服务的接管等的实际机制取决于外部 HA 软件 (如 Heartbeat). 。也可使用单个 MDS “3 EyMDS 恢复，但此时恢复将花费重启单个 MDS 所需的时间。启用强制恢复功能，将通知客户端MDS 重新启动 (备份或恢复的主服务器) 的消Ao Pog Ay Want in-flight 请求超时或空亲时间的 ping 消妃来检测 MDS 故障。在这两种情况下，各户端都会连接",
        "服务器的恢复超时窗口，因为不能确保所有客户端都及时收到了服务器重新局动的通知。即使在这样的混合环境中，完成恢复的时间也可能缩短，因为支持祈使式恢复的客户端仍然会接到通知，及时重新连接到服务器，一旦最后一个不支持祈使式恢复的客户端检测到服务器故障，就能完成恢复。在祈使式恢复机制中，MGS以目标状态表 (Target Status Table) 的形式持有关于Lustre目标的额外信息。在MGS上，每当注册一个目标时，在该表中就要增加相应的条目来识别该目标。该条目包含了NID信息，以及目标的状态/版本信息。当客户端挂载文件系统时，会以Lustre配置日志的形式，缓存并锁定该表的一个副本。当目标重启时，MGS撤销了客户端的锁，强制所有客户端重新加载该表。所有的新目标将获得一个新的版本号，客户端检测到了版本号的更新，就会重新连接到重启的目标上。祈使式恢复要能成功将服务器的重启通知给所有客户端，有赖于客户端已经在MGS上的注册好，而在MGS重启的情况下，因为没有其他节点可以通知客户端，所以MGS在第一次启动时将禁用IR一段时间。这个时间间隔是可以配置的。由于MGS在恢复中至关重要，因此强烈建议MGS节点与MDS分开。如果MGS位于MDS节点上上，那么在MDS/MGS故障的情况下，MDS的重启将无法使用祈使式恢复机制，客户端只能始终对MDS使用基于超时的恢复。在OSS故障和恢复的情况下，仍然会使用祈使式恢复机制。不乎的是，MGS无法知晓有多少客户端已成功收到通知，或某个特定客户端是否已收到重新局动的目标信息。MGsS唯一能做到的就是，告诉目标所有客户端都具有祈使式恢复能力，因此没有必要等所有客户端完成重新连接。出于这个原因，我们仍需使用目标端的超时策略，但是此超时值可能比正常 恢复的超时值短得多。本参数用于通过 tactor 来控制目标的恢复窗口。如果启用了祈使式恢复，重新启动的目标上恢复超时窗口通过以下方式计算;新的超时时长 = recovery time * factor / 10factor 必须是一个在 [1，101] 范围内的值，默认值是5 。值为 8",
        "发送的所有请求进行排序，直到请求被分配事务编号。XID 还可用于重新生成回复 ，以唯一地标识服务右上的每个客户端的请求。38.2.2. 事务编号服务器会分配一个事务编号给服务器处理的每个涉及状态更改〈元数据更新、文件打开、写入等，具体取决于服务需类型) 的客户器请求。该事务编号对于目标来说是唯一的，工作于服务套范围，是单调递增的 64 位整数。每个文件系统修改请求的事务纺人将与客户端请求的回复一起发回客户靖。事务编号允许客户端和服务禹明确地对每个文件系统更改进行排序，以便需要时进行恢复。发送给客户端的每个回复 〈无论请求类型如何) 还包含最后提交事务的编号，显示了提交给文件系统的事务编号的最大值。Lustre 软件使用的1diskfs和ZEFS后备文件系统确保了在随后的磁盘操作开始之前将早期磁盘操作提交到磁盘，最后提交的事务的编号还指示了任何具有更小事务山号的请求已被提人交到做盘。38.2.3. 重放和重发恢复 Lustre 文件系统可以分为两种不同类型的操作: 重放 (replay) 和重发 (resend) 。重放操作针对的是客户站已从服务硕收到操作成功的回复的那些操作。在服务融重司后，需要以和服务厚故障前报告的完全相同的方式重新执行这些操作。只有在服务骨发生故障时才能进行重放，否则和内存中并不会于失任何状态。重发操作针对的是客户端从未收到回复的那些操作，也就是说客户器并不知道它们的最终状态。客户奖近照 XID 的顺序再次癌服务硕发送未应答的请求，并等竺每个请求的回复。在某些情况下，重新发送的请求已由服务着处理并提交到磁盘〈可能还提交了相关操作) ，则服务硕将重新生成丢失的回复。在其他情况下，服务贷根本没有收到请求〈网络中断会发生这种状况) ，将像处理任何正半请求一样重新处理这些请求。服务需也可能收到了请求，但在发送故障前无法回复或提交到磁窟。464\nLustre 文件系统操作手册 译者:As大38.2.4. 客户端重放列表在服务融发生故障的情况下，进行服务种状态恢复"
    ]
}