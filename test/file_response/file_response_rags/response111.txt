{
    "query": "管理员发现 Lustre 文件系统中部分数据对象频繁出现锁竞争导致性能下降，可以通过哪些参数配置调整锁竞争检测阈值及竞争状态持续时间？",
    "summaries": [
        "Lustre 文件系统中的授权缓存允许数据在超过 OST 配额时仍能成功写入，这可能导致配额限制失效。通过调整客户端参数可缓解此问题。Lustre 还提供配额统计信息，用于监控和分析配额操作性能。此外，Lustre 支持与分层存储管理 (HSM) 的集成，使文件可在高速缓存的 Lustre 文件系统和较慢的 HSM 存储之间同步。",
        "Lustre可调参数全解介绍了多个用于配置和优化Lustre文件系统行为的参数，涵盖Job ID设置、配额管理、缓存控制、数据校验、HSM管理、网络请求调度、TBF规则配置以及资源竞争控制等方面。这些参数允许管理员根据具体需求调整系统性能和行为，如设置Job ID格式、清除统计数据、控制写入缓存大小、启用或禁用扩展属性缓存、配置HSM请求限制、调整网络请求策略等。此外，还涉及OST和MDT的资源竞争阈值、锁数量及超时设置，以提升系统稳定性和效率。",
        "Lustre 文件系统中的 `sync_on_lock_cancel` 参数用于控制在锁取消时是否同步日志，以避免数据不一致。该参数可设置为 `always`、`blocking` 或 `never`。建议不要禁用此功能，以免数据损坏。此外，Lustre 提供了多个参数来优化客户端元数据 RPC 流，如 `max_rpcs_in_flight` 和 `max_mod_rpcs_in_flight`，用于控制并行元数据操作的数量，从而提升性能。同时，通过 `rpc_stats` 可以监控元数据 RPC 的执行情况，帮助调整参数以适应不同的工作负载。Lustre 还使用自适应超时机制来动态调整 RPC 超时时间，以提高系统稳定性。"
    ],
    "contents": [
        "授权缓存和配额限制在 Lustre 文件系统中, 授权缓存并不受配额限制影响。为加速 TO ，OSTs 会向 Lustre客户端授权缓存。该缓存使数据即使超过 OSTs 配额，仍能成功写入，并重写配额限制。顺序是:1. 用户将文件写入 Lustre 文件系统。2. 如果 Lustre 客户端拥有足够的授权缓存，则会向用户返回\"成功\" 并安排在 OSTs 上的写入操作。3. 因为 Lustre 客户已经向用户返回\"成功\"，OST 不能使这些写入失败。由于授权缓存，写入操作将始终重新配额限制。例如，如果您为用户 A 设置 400GB的配额并使用 IOR 从一批客户端为用户 A 写入数据，则您将写入比 400GB 多得多的数据，最终导致超出配额的错误 (EDQUOT)。注意授权缓存对配额限制的作用可以得到缓解，但无法消除。运行以下命令减少客户端上及数据最大值 〈最小值为 1MB) :* lctl set param osc.*.max dirty mb=825.8. Lustre 配额统计信息Lustre 软件可以收集监控配额活动的统计信息，如特定期间发送的配额 RPC 类型、完成RPC 的平均时间等。这些统计信息对于衡量 Lustre 文件系统的性能很有用。300\nLustre 文件系统操作手册这ay43) ACen} A CAS min time，max time和sum time值组成。配额事件sync_acq reqsync _rel reqasync_acq reqasync _rel reqwait_for_blk_quota(Iquota_chkquota)wait_for_ino quota(Iquota_chkquota)wait_for_blk_quota(Iquota_pending commit)wait_for_ino quota(Iquota_pending commit)wait for pending blk_quota_req(qctxt_wait_pending dqacq)wait for pending ino_quota_req(qctxt_wait_pending dqacq)nowait for pending blk_quota_req(qctxt_wait_pending dqacq)说明配额从设备发送获取配额的请求并等待回复。配额从设备发送释放配额的请求并等待回复。配额从设备发送获取配额的请求但不等待回复。",
        "quota_req(qctxt_wait_pending dqacq)说明配额从设备发送获取配额的请求并等待回复。配额从设备发送释放配额的请求并等待回复。配额从设备发送获取配额的请求但不等待回复。配额从设备发送释放配额的请求但不等待回复。在数据写入 OSTs 之前，OSTs 将检查剩余块配额是否足够。这将在 l1quota_chkquota Pe aH完成的。在 MDS 上创建文件之前，MDS 检查剩余的 inode配额是否足够。这将在 Iquota_chkquota 函数中完成的。将块写入 OST 后，会更新相关配额信息。这是在Iquota_ pending commit 函数中完成的。文件完成创建后，会更新相关配额信息。这是在Iquota_pending commit 函数中完成的。在MDS 或0STs 上，有一个线程随时为特定UID/GID 发送块配额请求。其他线程发送配额请求则需要等待。这是在qctxt_wait pending dqacq 函数中完成的。在MDS 上，有一个线程随时为特定 UID/GID发送 inode 配额请求。其他线程发送配人额请求则需要等待。这是在qctxt_wait pending dqacq 函数中完成的。在MDS 或OSTs 上，有一个线程随时为特定UID/GID 发送块配额请求。当线程进入qctxt_wait pending dqacq 时，无需再等待。这是在 qctxt wait pending dqacq301\n——ULDLustre 文件系统操作于册 译者:这ay配额事件 说明PACA SE WHY 0nowait for pending ino quota req 在MDS 上，有一个线程随时为特定 UID/GID(qctxt_ wait pending dqacq) 发送 inode 配额请求。当线程进入qctxt wait pending dqacq 时，无需再等待。这是在 qctxt wait pending dqacq函数中完成的。quota_ctl {# FA lfs ssetquota ，1Lfs quota 等将生成 quota_ctl 统计信息。adjust_qunit 每当 qunit 发生调整时，都将被记录。25.8.1. 解析配额统计信息AC AMZ ze Ot at Lustre 文件系统性能的重要指标",
        "max rpcs in flight 参数定义了客户端并行发送到 MDT 目标的元数据 RPC 的最大数量，包括更改和不更改文件系统的RPC。这包含了所有文件系统元数据操作，如文件或目录统计、创建、取消链接等。其默认值为8，最小值为1，最大值为 256。在 Lustre 客户端上运行以下命令设置max rpcs in flight Bx:client$ lctl set param mdc.*.max tpcs in flight=16MDC ji) max_mod_rpes_in_flight 参数定义了客户端并行发送到 MDT 目标的更改文件系统的RPC 的最大数量。例如，Lustre 客户端在执行文件或目录创建、取消链接、访问权限修改、所有权修改时会发送更改式 RPC。其默认值为7，最小值为1，节KIBYA 256.在 Lustre 客户端上运行以下命令设置max mod _rpcs in flight BR:client$ lctl set param mdc.*.max_mod_rpcs in flight=12max mod rpcs in flignt值必须比max_ rpcs in flight 值小 同时也必须小于或等于MDT 的 max_mod_rpcs_per_client 值。如果未满足其中一个条件，设置将失败，并在 Lustre 日志中写入明确的错误消息。498\n1—23456101213141516171819Lustre 文件系统操作手册 译者:这ayMDT 的 max mod_rpcs per client参数是内核模块mdt的可调参数，它定义了每个客户问所允许的处理中的最大更改式 RPC 数量。该参数可以在运行时进行更新，但此更改仅对新客户端连授有效。其默认值为8。在 MDS 上运行以下命令设置max mod rpcs per client Bx:mds$ echo 12 > /sys/module/mdt/parameters/max mod_rpcs per client39.4.5.2. 客户端元数据 RPC PEGE rpc_stats 文件包含了显示更改式 RPC 相关信息的直方图，可用于确定应用程序执行更改文件系统的元数据操作时所实现的并行级sl).示例:client$ lctl get param mdc.*.rpc_ statssnapshot time:",
        "hsm_purge: 清除所有已提交的HSM请求hsm_max_requests: 设置同一时间内活跃的HSM请求的最大数量hsm_policy: 启用或禁用HSM重试操作hsm_grace_delay: 设置从HSM请求列表中清除一个HSM请求前的延迟时间root_squash: 设置根 (root) 用户访问Lustre所使用的UID和GIDnosquash_nids: 设置不适用Root squash的客户端列表ost_nrs_policies: 设置OST服务使用的网络请求调度策略。mdt_nrs_policies: 设置MDT PTLRPC服务使用的网络请求调度策略ost_nrs_orr_offset_type: 设置ORR策略在每个批次内排序RPC的偏移量类型ost_nrs_orr_supported: 设置采用ORR策略处理哪些类型的的RPCost_nrs_trr_quantum: 设置0ST上TRR策略每批次RPC的最大数目ost_nrs_trr_offset_type: 设置TRR策略在每个批次内排序RPC的偏移量类型ost_nrs_trr_supported: 设置0ST上的TRR策略要处理哪些类型的的RPCost_nrs_delay_min: 设置Delay策略延迟处理OST请求的最短时间mdt_nrs_delay_min: 设置Delay策略延迟处理MDT请求的最短时间ost_nrs_delay_max: 设置Delay策略延迟处理OST请求的最长时间mdt_nrs_delay_max: 设置Delay策略延迟处理MDT请求的最长时间ost_nrs_delay_pct: 设置Delay策略处理多少百分比的OST请求mdt_nrs_delay_pct: 设置Delay策略处理多少百分比的MDT请求ost_tbf_nid_rule_start: 在OST上创建一个TBF NID策略的规则mdt_tbf_nid_rule_start: 在MDT上创建一个TBF NID策略的规则ost_tbf_jobid_rule_start: 在OST上创建一个TBFjJoblD策略的规则作者: 李希 更新时间: 2023年6月7日\nLustre 可调参数全解52. mdt_tbf_jobid_rule_start: 在MDT上创建一个TBFjoblD策略的规则53. ost_tbf_uid_rule_start: 在OST上创建一个TBF UID策略的规则54. mdt_tbf_uid_rule_start: 在MDT上创建一个TBF",
        "Lustre 可调参数全解目录1.jobid_var: 设置哪个环境变量保存了进程的joblD2.jobid_name: 设置job ID的格式3. job_stats_clear: 清除Jobstats昧积的统计数据4.job_cleanup_interval: 设置jobstats的自动清理时间间隔5. quota_enforce: 设置在用户、组和项目配额中局用哪几项6. identity_acquire_expire: 设置组upcall程序完成的超时时限7. identity_expire: 设置组downcall数据缓存的过期时间8. changelog_mask: 设置Changelog日志的记录类型掩码9. ost_degraded: 设置0ST是否处于降级模式10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.30.31.32.33.34.38.39.40.41.42.43.44.45.46.47.48.49.50.51.enable_remote_dir: 设置是否允许在MDT上创建远程子目录enable_remote_dir_gid: 设置允许创建远程目录的组IDmax_dirty_mb_per_osc: 设置允许每个0OSC写入缓存的最大脏数据量max_dirty_mb_per_client: 设置允许每个客户端写入缓存的最大脏数据量disable_object_precration: 禁用OST上的对象预创建osc_active: 激活或停用所有OSC上的OSTmdt_readonly: 将MDT设置为只读或允许读写reserved_mb_low: 设置在OST可用空间低于何阔值时，停止对象分配reserved_mb_high: 设置在OST可用空间高于何阅值时，开始对象分配。qos_threshold_rr: 设置数据对象分配方法切换时的空朵空间差异闭值qos_prio_free: 设置加权分配器基于空间空间的加权因子dom_stripesize: 设置DoM (Data on MDT) 分条大小的上限xattr_cache: 局用或荣用客户端上的扩展属性缓存checksum_pages: 在客户端上启用或茶用内存中的数据校验和线上数据校验checksum_type: 更换RPC校验码算法hsm_control: 启动、禁用或关闭HSM协调器线程hsm_purge: 清除所有已提交的HSM请求hsm_max_requests: 设置同一时间内活跃的HSM请求的最大数量hsm_policy: 启用或禁用HSM重试操作hsm_grace_delay: 设置从HSM",
        "TBFjoblD策略的规则53. ost_tbf_uid_rule_start: 在OST上创建一个TBF UID策略的规则54. mdt_tbf_uid_rule_start: 在MDT上创建一个TBF UID策略的规则55. ost_tbf_gid_rule_start: 在OST上创建一个TBF GID策略的规则56. mdt_tbf_gid_rule_start: 在MDT上创建一个TBF GID策略的规则57. ost_tbf_opcode_rule_start: 在OST上创建一个TBF Opcode策略的规则58. mdt_tbf_opcode_rule_start: 在MDT上创建一个TBF Opcode策略的规则59. ost_tbf_complex_rule_start: 在OST上创建一个TBF一般化策略的规则60. mdt tbf complex_rule_start: 在MDT上创建一个TBF一般化策略的规则61. ost_tbf_rule_change_rate: 更改OST服务上TBF规则的速率62. mdt_tbf_rule_change_rate: 更改MDT服务上TBF规则的速率63. ost_tbf_rule_change_rank: 更改OST服务上TBF规则的排序64. mdt_tbf_rule_change_rank: 更改MDT服务上TBF规则的排序65. ost_tbf_rule_stop: 删除ODST服务上一个TBF规则66. mdt_tbf_rule_stop: 删除MDT服务上一个TBF规则67. ost_contended_locks: 设置判定数据对象处于竞争状态的锁数量68. ost_lwp_contended_locks: 设置判定LWP的对象处于竞争状态的锁数量69. ost_contention_seconds: 设置OST资源在LDLM锁数目降下来后，仍保持在竟争状态的时间70. ost_lwp_contention_seconds: 设置LWP资源在LDLM锁数目降下来后，仍保持在竞争状态的时间71. osc_contention_seconds: 设置资源在OSC竞争状态下保持的时间72. ost_max_nolock_bytes: 设置无锁MO所允许的最大请求字节数73. ost_lwp_max_nolock_bytes: 设置LWP无锁MMO所允许的最大请求字节数74. ost_brw_size",
        "式 RPC 相关信息的直方图，可用于确定应用程序执行更改文件系统的元数据操作时所实现的并行级sl).示例:client$ lctl get param mdc.*.rpc_ statssnapshot time: 1441876896.567070 (secs.usecs)modify RPCs in flight: 0modifyrpcs in flight rpcs + Cum %0 : 0 0 01: 56 0 02 : 40 0 03: 70 0 04 41 0 05: 51 0 16: 88 0 17: 366 1 28: 1321 5 89: 3624 15 2310: 6482 27 5011: 7321 30 8112: 4540 18 100文件内容包括:。 snapshot time 一读取文件时的 UNIX epoch 瞬间。。 modify RPCs_in_ flight 一 MDC 发起但当前还未完成的更改式 RPC 数。该值必须永远小于或等于max mod rpcs in flight.。 rpcs in flight 一发送RPC 时当前挂起的更改式 RPC 数量，包括相对百分比(3) 和宗积百分比 (cum %).499\n—Lustre 文件系统操作手册 译者:这ayMW AR KR ub ay BE oe st 7c Bt ie RPC AE KRW CAA Ke INimax mod_rpcs_in flight值的挂起元数据RPC，则意味着可以增加max mod rpcs_ in flignt值来提高元数据更改性能。39.5. Lustre 文件系统超时配置在 Lustre 文件系统中，RPC 超时使用目适应超时机制〈默认为司用)。服务融跟踪RPC 完成时间并同和客户端报告，以便估计未来 RPC 的完成时间。客户问使用这些佑计值来设置 RPC 超时值。当服务货请求处理因某种原因而减慢时，服务硕 RPC 完成时间延长，客户端则随之修改 RPC 超时值以允许更多的时间来守成RPC。如宁服务郁上排队的 RPC 接近客户端指定的RPC 超时，为避免 RPC 超时和上断开和重新连接的循环，服务僚会癌客己端",
        "quota_ctl 统计信息。adjust_qunit 每当 qunit 发生调整时，都将被记录。25.8.1. 解析配额统计信息AC AMZ ze Ot at Lustre 文件系统性能的重要指标。正确解析这些统计信息可以帮助您诊断配质问题，并做出一些调整，以提高系统性能。例如，如果您在 OST 上运行此命令:lctl get_param lquota.testfs-OSTO000.stats您将得到类似以下的结果:Snapshot time 1219908615.506895 secs.usecsasync _acq req 1 samples [us] 32 32 32async rel req 1 samples [us] 555nowait for pending blk quota _req(qctxt wait pending dgacq) 1 samples [us] 2\\2 2quota_ctl 4 samples [us] 80 3470 4293adjust_qunit 1 samples [us] 70 70 70在第一行中，snapshot _ time 表明获得这些数据的时间。其余行列出了配额事件及其相关数据。在第二行中async acq req事件发生一次。此max timefilsum time分别为32、32 和32。单位是微秒 〈hs) 。在第五行中quota ctl事件发生四次。此max time和sum time分别为80、3470 和 4293。单位是微秒 (us) 。TWalin!Be 件 的min time,{in|beni件 的min time,302\nLustre 文件系统操作手册这ay(在 Lustre 2.5 中引入)第二十六章分层存储管理 (HSMD26.1. 简介Lustre 文件系统可以使用一组特定的功能绑定到分层存储管理 (HSM) 解决方案。这些功能可将 Lustre 文件系统连接到一个或多个外部存储系统 〈通消是 HSM) 。通过绑定到HSM 解决方案，Lustre 文件系统可以作为高速缓存在这些速度较慢的 HSM 存储系统的前端工作。Lustre 文件系统与 HSM 的集成提供了一种机制，使文件同时存在于 HSM 解决方案中，并在 Lustre 文件系统中存有元数据条目可供检查。读取，写入或截断文件将触发文件数据从 HSM 存储中取回到 Lustre 文件系统中。将文件复制到",
        "cancel 功能〈黑认司用) WRIT 2 he Pi Be BS入对象的交叉区域后的 OSS 及其中一个客户端朋省时可能导致的数据不一致问题。当违反连续写入的 POSIX 要求并存在损坏数据的淤在风险时，将创建一个条件。局用sync-on-lock-cancel 后，如果取消的锁附加了任何满足此条件的不稳定的写入，则 OSS 会在锁取消时将日志同步导入磁姓。因此，尽管禁用sync-on-Iock-cance1l功能可以提升并发写入工作负载的性能，我们仍建议您不要蔡用此功能。497\n—Lustre 文件系统操作手册这aysync_on lock _cancel1人参数可设置为以下值: :。 always 一在锁取消时强制执行日志更新 (async_journal司用时的默认值)。\"blocking一只在因阻塞回调引起的锁取消时强制执行日志更新。\"nevet 一不强制执行任何日志更新 〈async_journal华用时的默认值)。例如，将 sync_on_lock_cancel 设置为不强制执行日志更新，使用以下类似命4S:$ lctl get_param obdfilter.*.sync_on lock cancel2 obdfilter.lol-OST0001.sync on lock cancel=never——39.4.5. 客户端元数据 RPC 流的调试客户端元数据RPC 流表示客户端并行发起的到MDT 目标的元数据RPC。元数据RPC 可以分为两类: 不更改文件系统的请求〈如 getattr 操作) 和更改文件系统的请求(如 create、unlink、setattr 操作) 。为优化客户端元数据RPC iit, Lustre 提供了几个可调参数来根据网络条件和集群大小调整行为。请注意，增加并行发起的元数据RPC 的数量可能会改善元数据密集型并行应用程序的性能，但会在客户端和 MDS 上消耗更多的内存。(在 Lustre 2.8 中引入)39.4.S.1. 配置客户端元数据RPC流 MDC AY max rpcs in flight 参数定义了客户端并行发送到 MDT 目标的元数据 RPC 的最大数量，包括更改和不更改文件系统的RPC。这包含了所有文件系统元数据操作，如文件或目录"
    ]
}