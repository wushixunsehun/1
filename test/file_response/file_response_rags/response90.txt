{
    "query": "如何通过参数配置 Lustre 的 HSM（分层存储管理）协调器线程行为及请求处理策略？请结合线程启停、请求清理和重试等机制说明。",
    "summaries": [
        "Lustre 文件系统通过 HSM（Hierarchical Storage Management）管理数据在文件系统与存储解决方案之间的迁移。请求包括 ARCHIVE、RELEASE、RESTORE、REMOVE 和 CANCEL，其中 RELEASE 是同步操作，其他由 MDT 协调处理。默认请求超时时间为 3600 秒，可通过命令设置。自动恢复机制在访问已释放文件时触发，IO 会被阻塞直到恢复完成。用户可通过命令监控请求状态和文件状态，文件状态包括 NOARCHIVE、NORELEASE、DIRTY 和 LOST。调试工具可控制协调器行为、设置最大请求数、调整策略及 grace delay。HSM 变更日志记录相关事件类型，如存档、恢复、取消等。",
        "Lustre 文件系统通过 HSM（Hierarchical Storage Management）解决方案实现数据的存档和恢复。文件的元数据存储在 Lustre 中，而实际数据则存储在 HSM 存储中。读写或截断文件会触发数据从 HSM 恢复到 Lustre，而存档则是将数据从 Lustre 移动到 HSM。此过程由代理（Agent）和复制工具（copytool）完成，其中 copytool 负责协调数据传输。每个 HSM 解决方案需分配唯一的 ARCHIVE ID，支持多后端系统。代理需注册到 MDT，并通过 UUID 标识。为防止阻塞，系统设置了请求超时机制。",
        "Lustre 文件系统操作手册摘要：本文介绍了 Lustre 文件系统的 HSM 标志、事件和错误代码的处理方式，以及使用 liblustreapi 辅助函数提取信息的方法。策略引擎负责自动调度存档和发布请求，推荐使用 Robinhood 工具进行管理。PCC（持久化客户端缓存）利用 SSD 提供本地缓存，提升 IO 性能，减少 OST 压力。PCC-RW 作为 HSM 后端，通过本地文件系统缓存数据，支持读写操作，并在文件附加成功后直接访问缓存，确保数据同步与一致性。"
    ],
    "contents": [
        "存储的数据集规模很大，最大数据中心的规模可达到数特 PEB，因此将大部分数据存储在 HDD 上，而只将活动的子数据集存储在 SSD 上，人性价比更高。PCC 机制使配备了内部 SSD AY eae Wy EL ASH IO 模式的读写密集型应用提供额外的性能。PCC 与 Lustre HSM 和布局锁机制相结合，使用本地 SSD 存储提供持久化缓存服务，同时允许在本地和共享存储乙间迁移单个文件。这使得 IO 密集型应用可以在客户端下点上读写数据，同时又不失 Lustre 全局命名空间的优势。在 Lustre 客户端上使用这种缓存的主要优势在于，由于不受其他客户端的 IO 干扰，因此绥存数据的 IO 堆栈更加简单，从而优化性能。且对客户端节点的硬件没有特殊要309\nLustre 文件系统操作手册 译者: 李硕求，任何 Linux 的文件系统，比如 NVMe 设备上的 ext4，都可以作为 PCC 缓存。本地文件缓存减少了对象存储目标 (OSTs) 的压力，因为小的或随机的 IO 可以聚合成大的顺序 IO ，临时文件甚至不需要刷新到 OSTSs。27.2. 设计27.2.1. Lustre 读写 PCC BECoordinator MDS \\1. Metadata I/O path2. HSM restore request3. PCC attachData Object creation( fd2 ) { fd3 )\\ \\~一 “~-7 1.Normal IO path2. Data archive ——>fdn ) _ 3. Data restore(om®&gp) ©~—OSTs图 27: Overview of the Lustre file system HSM图 27.1 PCC-RW 架构Lustre iH 3 (2 7A SE CES HSM bil, peri BE (te BOK FCT AY VS ERR而 PCC-RW 实际上是一个 HSM 后端存储系统，它在 Lustre 客户端上提供一组高速本地缓存。上图展示了 PCC-RW 架构，每个洛户端都使用目己的本地存储，通首是 NVMe的，用作",
        "3: 文件已被释放。* HE REMOVE = 4: 已删除的请求被自动执行。\"HE_STATE = 5 : 文件标志已更改。308\nLustre 文件系统操作手册这ay- HSM 标志 (3 bits)° CLF HSM DIRTY=0x1在上面的例子中，0x280 标示错误代码为0，事件为 HE_STATE.使用1iblusttreapi时，可以借助一些辅助函数轻松地从位掩码中提取不同的值OU: hsm get cl event(), hsm get cl flags(),. hsm_get_cl_ error().v26.8. 策略引擎Lustre 文件系统在任何情况下《〈如空间不足时) 都没有内部组件负责自动调度存档请求和发布请求。自动调度存档操作由策略引擎完成。策略引擎是一个使用 Lustre 文件系统的特定 HSM API来监视文件系统和调度请求的用户空间程序。我们建议您在专用和客户端上运行策略引擎 CRU AC), FRSA Lustre 2.5 以上版本。推荐使用Robinhood 策略引擎26.8.1. RobinhoodRobinhood 是大型文件系统的策略引擎和报告工具。它负责维护数据库中文件系统元数据的副本，以供任意查询。Robinhood 通过定义基于属性的策略，实现了调度文件系统条目的批量行为; 通过 Web 界面和命令行工具，为管理员提供了文件系统内容的全面视图。同时，它也为快速的 find 和 qu操作提供了增强版的克隆。Robinhood 是一个外部项目，可以用于各种配置。更多信息请参阅: https://sourceforge.net/apps/trac/robinhood/wikiDoc。(在Lustre 2.9 引入)第二十七章持久化客户端缓存 (PCC)27.1. 简介基于闪存的固态硬盘 (SSD) 有助于《一定程度地) 缩小磁力磁盘和 CPU 之间不断扩大的性能差距。SSD 在存储殿构中建立了一个新的层，无论是在价格还是性能方面都是如此。在 Lustre 中存储的数据集规模很大，最大数据中心的规模可达到数特 PEB，因此将大部分数据存储在 HDD 上，而只将活动的子数据集存储在 SSD 上，人性价比更高。PCC 机制",
        "无法提交请求。。Ppurge: 清除所有记录的请求。不改变协调器状态。307\nLustre 文件系统操作手册这ay26.6.2. max requestsmax requests jéla] WYANT RAL (BED Dia) 。该值与代理数量无Ko例如，如果有2个MDT 和4个代理，代理不需要处理 2 倍的max_1 $ lctl set param mdt.SFSNAME-MDTO000.hsm.max requests=1026.6.3. policy更改系统行为，其值可以通过将+ 或 (EA BOR ASI AE BR1 $ lctl set Param mdt.SFSNAME-MDTO000.hsm.policy=+NRA可 以是以下情况组合的值:* NRA: 不进行重坛。如果恢复失败，不自动重调度请求。。NBR : 不阻塞 IO 来等待恢复。即触发恢复 ，但不阻塞客户端。访|返回 ENODRATA。26.6.4. grace delayrequests.可已释放的文件grace_delay 指的从整个请求列表中清除请求〈成功或失败) 的延迟，单位为秒。1 $ lctl set param mdqt.SESNAMPE-MDT0000.nhsm.grace delay=1026.7. 变更日志Lustre S/F RBCS Shae HSM 相关事件的类型为 HSM 的变更日志。1 16HSM 13:49:471.469433938 2013.10.01 0x280 t=[0x200000400: 0x1: 0x0]有 i 信息可以写入每条 HSM 记录: 变更文件的FID AI ACHENS. fey LA下信息进行编码 〈最低位在前)错误代码〈如采存在) (7 bits)。 HSM 事件 (3 bits)* HE ARCHIVE = 0: 文件已被存档。。 HE RESTORE = 1: 文件已恢复。。 HE CANCEL = 2: 关于此文件的请求已被取消。* HE RELEASE = 3: 文件已被释放。* HE REMOVE = 4: 已删除的请求被自动执行。\"HE_STATE = 5 : 文件标志已更改。308\nLustre 文件系统操作手册",
        "同时存在于 HSM 解决方案中，并在 Lustre 文件系统中存有元数据条目可供检查。读取，写入或截断文件将触发文件数据从 HSM 存储中取回到 Lustre 文件系统中。将文件复制到 HSM 存储器的过程称为存档。存档完成后，便可删除 Lustre 文件数据《〈即释放) 。将数据从 HSM 存储取回到 Lustre 文件系统的过程称为恢复。存档和恢复操作需要用到名为\"Agent\" (代理) 的 Lustre 文件系统组件。代理是为装载处理中的 Lustre 文件系统而专门设计的 Lustre 客户端节点。在代理上，运行有一个名为\"copytool\"〈复制工具) 的用户空间程序，以协调 Lustre 文件系统和HSM 解决方案之间文件的存档和恢复。PRES ORIN R MDT Fi\"coordinator\" 〈协 Ha) aT EEN 分派。OSSHSM world图 26: Overview of the Lustre file system HSM1 Lustre 文件系统 HSM 总览N图 226.2. 设置26.2.1. 要求设置 Lustre/HSM 配置，您需要:。 标准 Lustre 文件系统 (2.5.0 及以上版本)”最少两个客户端，一个用于生成有效数据的计算任务，一个作为代理。303HSM protocols |\n—2—2—Lustre 文件系统操作手册 译者:这ay可以使用多种代理。所有代理都需要共享对后端存储的访 Ms 对于 POSIX copytool来说，像 NFS 或其他 Lustre 文件系统这样的POSIX 名称空间是合适的。26.2.2. 协调器 (coordinator)将 Lustre 文件系统绑定到 HSM 系统上，必须在每个文件系统 MDT 上激活协调需请运行:$ lctl set param mdt.SFSNAME-+MDTO000.hsm_control=enabledmdqt.LIustre-MDIU000.hsm_control=enabled确认协调硕已被正常司用:$ lctl get_param mdt.SFSNAME-+MDTO000.hsm_ controlmdt.lustre-MDTO000.hsm_ control=enabled26.2.3. 代理 (agent)tila asa, TERED EE aA TI (copytool) 以连接到你的 HSM 7储。如果你的 HSM",
        "为ARCHIVE ID 1 启动 3 个 copytool 实例, 则这三个实例都将使用 Archive ID 1\" 标识。同样的规则也适用于处理使用 Archive ID “2\" 为标识的 HSM B 的 copytool 实例。发出HSM 请求时，您可以使用--azchive开关来选择要使用的后端。在本例中，文件foo将被存档到后端 ARCHIVE ID 5\" 中:1 $ lfs hsm _ archive --archive=5 /mnt/lustre/foo当未指定-=-azchive开关时，可使用默认 ARCHIVE ID 。和定义默认 ARCHIVE ID:1 $ lctl set param -P mdqt.1uUstrerMDT0000.hsm.qefault archive id=5运行1fs hsm _ state命令查看已归档文件的ARCHIVE ID:1 $ lfs hsm state /mnt/lustre/foo2 /mnt/lustre/foo: (0x00000009) exists archived, archive id:526.3.2. 注册代理Lustre 文件系统为每个文件系统的每个客户端挂载点分配唯一UUID。每个 Luster挂载点只能注册一个 copytool。因此，在每个文件系统中，UUID 也是 copytool 的唯一标识。通过在 MDS “_E (4S MDT) 运行以下命令，可以检索当前注册的 copytool 实例 (代理 UUID) :1 $ lctl get param -n mdt.SFSNAME-MDTO000.hsm.agents2 uuid=al9b2416-0930-fclf8c58-c985ba5127ad archive id=1 requests=[current: 0ok:0 errors:0]返回的值域为:。uuid : 此 copytool 使用的客户端挂载点。。 archive id: 此copytool 可访问的ARCHIVE ID 列表 UD 之间由去号隔开)。。 requests : 有关此 copytool 处理的请求的各种统计信息。26.3.3. 超时一个或多个 copytool 实例可能会遇到导致它们无法啊应的情况。为避免系统阻塞对相关文件的访问，我们为请求处理定义了一个超时值。copytool 必须在这上段时间内完全完成请求，",
        "一个或多个 copytool 实例可能会遇到导致它们无法啊应的情况。为避免系统阻塞对相关文件的访问，我们为请求处理定义了一个超时值。copytool 必须在这上段时间内完全完成请求，其默认值为 3600 秒。1 $ lctl set param -n mdt.lustre-MDT0000.hsm.active request timeout305\nLustre 文件系统操作手册这ay26.4.每个26.4.请求文件系统和 HSM 解决方案之间的数据管理是由请求驱动的。有以下五种类型 :ARCHIVE: 从 Lustre 文件系统揽贝数据至 HSM 解决方案。RELEASE : 从 Lustre 文件系统移除数据。RESTORE : 从 HSM 解决方案拷回数据至相应的 Lustre 文件系统。REMOVE : 从HSM 解决方案中删除拷贝数据。CANCEL : 取消进行中或等待中的请求。JAA RELEASE 是同步进行且不需要协调需配合的操作。其他请求由协调锅处理，MDT 协调釉对和它们进行弹性的管理。1. 命令请求通 了过1fs ff 6人 th Ae:1 $ lfs hsm archive [--archive=ID] FILE1 [FILE2...]2 $ lfs hsm release FILE1 [FILE2...]3 $ lfs hsm restore FILE1 [FILE2...]4 $ fs hsm remove FILE1 [FILE2...]26.4如果没有通过 --archive #$% ARCHIVE ID ，请求将被发送到默认 ARCHIVE ID..2. 自动恢复当一个进程试图读取或修改已释放的文件时，它们将被被目动恢复。相关 IO 将被阻塞文件1 S ca直到文件恢复完成。这些操作对进程来说是透明的。例如，以下命令将自动恢复该(如果它已被释放) :t /mnt/lustre/released file26.4.3. 请求监控1 S 1Lc可以监控每个 MDT 上的已注册请求列表和它们的状况，运行:tl get Param -n mdt.lustreMDT0000.hsm.actions当前复制工具正在处理的请求列表可通过以下命令获取:1 $ lctl get param -n mdt.lustre-MDTO0000.",
        ":tl get Param -n mdt.lustreMDT0000.hsm.actions当前复制工具正在处理的请求列表可通过以下命令获取:1 $ lctl get param -n mdt.lustre-MDTO0000.hsm.active requests306\nLustre 文件系统操作手册 译者:这ay26.5. 文件状态当文件被存档〈释放) ，它们在 Lustre 文件系统上的状态发生改变。使用以下1fs命令碍看文件状态:1 $ lfs hsm State FILE1 [FILE2...]可以为每个文件设置以下的特定策略标志:* NOARCHIVE : 该文件永远不会被存档。* NORELEASE : 该文件永远不会被释放。如果已经设置了RELEASED标志，则不能再设置此标志。。DIRTY: 文件在复制到 HSM 解决方案后发生了更改。DIRTY 文件需要再次存档。DIRTY 标志只能在已有EXIST标志的情况下设置。以下选项只能由 root 用户设置 :。 LOST: 该文件已存档，但其在 HSM 解雇方案上的副本由于某种原因 (如磁盘损坏) 丢失，并且不能进行恢复。如果该文件处于 RELEASE 状态，则文件丢失; 如果不处于RELEASE 状态，则该文件需要再次存档。有些标志可通过以下命令手动设置或清除:1S 1fs hsm set [FLAGS] FILE] [FILE2...]2 $ lfs hsm clear [FLAGS] FILE1 [FILE2...]26.6. 调试26.6.1. hsm_controlpolicyhsm control 负责控制协调堪活动并可以祖除动作列表。1 $ lctl set Param mdt.SFSNAME-MDTO000.hsm_control=purge可能的值有:。enabled : 司动协调需线程。在可用复制工具实例上分发请求。。 disabled: 暂停协调器活动，将不进行新请求分发，不处理超时。新的请求会被注册，但只有协调喜重新启动后才会进行处理。。 shutdown : 关闭协调器线程。将无法提交请求。。Ppurge: 清除所有记录的请求。不改变协调器状态。307\nLustre 文件系统操作手册这ay26.6.2. max requestsmax requests jéla] WYANT RAL (BED",
        "是一个 HSM 后端存储系统，它在 Lustre 客户端上提供一组高速本地缓存。上图展示了 PCC-RW 架构，每个洛户端都使用目己的本地存储，通首是 NVMe的，用作本地绥存的本地文件系统。绥存的 IO 操作的对象为本地文件系统中的文件，Mikey IO 操作的对象为 OST。PCC-RW 使用 Lustre 的 HSM 机制进行数据同步。每个 PCC 节氮实际上就是一个HSM 代理，并在其上运行痢一个 copy tool 实例。Lustre HSM copytool 用于将文件从本地绥存中恢复到 Lustre OSTs 上。任何从其他 Lustre 客户端对该客户端上 PCC 绥存文件的远程访问都会触发这个数据同步。如果 PCC 客户端脱机，绥存数据将暂时无法被其他客户端访问。在PCC 客户端重新司动、挂载 Lustre 文件系统并重司 copytool 后，数据将再次被访问。目前，PCC 客户端会将整个文件组存在本地文件系统中。在 IO 操作可以直接存取客户端缓存之前，必须先将文件附加到 PCC 上。Lustre 布局锁功能是为了确保缓存服务SERIE RAITRS Te 附加文件的操作成功后，文件数据可以直接对本地 PCC绥存进行读写。如果附加操作没有成功，客户端将简单地回到正希的IO 路径，即直310\nLustre 文件系统操作手册 译者: 李硕接对 OST 进行 JO。当另一个客户端上的进程试图读取或修改 PCC-RW 缓存的文件时，PCC-RW 缓存的文件会自动恢复 (同步) 到全局文件系统中。而相应的 IO 将被阻塞，直到被释放的文件恢复成功。这对应用程序来说是透明的。撤销布局锁可以随时自动将文件从 PCC 缓存中分离出来。可以通过Ifs peedetach命令，手动分离 PCC-RW 绥存文件。当缓存文件从缓存中分离出来并恢复到OSTs 后，绥存文件将从 PCC 文件系统中删除。失败的 PCC-RW 操作通常会返回相应的错误代码。但有一种特殊的情况不返回错误，即本地 PCC 文件系统的空间耗尽时，PCC-RW 可以目动回洲到正浓的 IO 路径，因为",
        ".hsm_ control=enabled26.2.3. 代理 (agent)tila asa, TERED EE aA TI (copytool) 以连接到你的 HSM 7储。如果你的 HSM 存储可以进行POSIX 访问，则该命令为:lhsmtool_ posix --daemon --hsrrroot SHSMPATH --archive=1 SLUSTREPATHPOSIX copytool 只能通过发送 TERM 信和号来关闭。26.3. 代理 (Agents) 和复制工具 (copytool)代理是运行 copytool 的 Lustre 文件系统客户端，而 copytool 是一个在 Lustre 和 HSM解决方案之间传输数据的用户空间和守护程序。由于不同的 HSM 解决方案使用不同的API, copytools 通常只能与特定的 HSM 一起使用。代理节点只能运行一个 copytool。以下规则适用于 copytool 实例: Lustre SCP AREER SE Pink, BES ARCHIVEID 〈请参见下文) 仅文持一个 copytool 进程。这是受制于 Lustre 软件， 与代理挂载的Lustre 文件系统的数量无关。与 Lustre 工具捆绑在一起，POSIX copytool 可以与任何导出 POSIX API 的 HSM 或外部存储一起使用。26.3.1. ARCHIVE ID 及多后端系统Lustre 文件系统可以绑定到几种不同的 HSM 解决方案。每个绑定的 HSM 解决方案由ARCHIVE ID 标识。必须为每个绑定的 HSM 解雇方案选择唯一的ARCHIVE ID 值，且其值必须介于1到 32 之间。Lustre 文件系统支持无限数量的 实例。每个 ARCHIVE ID 至少需要一个copytool。当使用 POSIX copytool 时，通过--archives开关定义ID。304\nLustre 文件系统操作手册 译者:这ay例如，如果单个 Lustre 文件系统绑定到 2 个不同的 HSMs (A 和了B)，则可以选择ARCHIVE ID 1\" 作为HSM A 的标识，ARCHIVE ID ”2\" 作为HSM B 的标识。如果为ARCHIVE ID 1 启动 3 个 copytool 实例, 则这三个实例都将使用 Archive ID 1\" 标识。同样的规则也适用于处理使用 Archive ID “2"
    ]
}