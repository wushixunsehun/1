{
    "query": "在 Lustre 文件系统中，如何通过参数配置实现对客户端连接的故障恢复时限控制？请结合软时限（recovery_time_soft）和硬时限（recovery_time_hard）参数说明作用。",
    "summaries": [
        "本文档介绍了Lustre文件系统中多个可调参数的设置和作用。其中，adaptive_timeout_max用于设置自适应超时机制的最长超时时间，当服务时间超过该值时RPC请求将超时；adaptive_timeout_history用于设置自适应超时机制记录历史事件的时间长度；at_early_margin用于在超时前发送提前回复以避免客户端超时；commit_on_sharing用于控制是否提交被其他客户端依赖的事务，以提高系统恢复的可靠性；timeout用于设置客户端等待服务器完成RPC的时限。此外，还介绍了mdt_req_buffer_history_max和ost_req_buffer_history_max用于设置MDT和OST服务的历史请求数上限。这些参数可根据实际需求进行调整，以优化系统性能和稳定性。",
        "Lustre 文件系统通过事务编号（XID）对客户端请求进行排序和唯一标识，确保文件系统操作的顺序性和可恢复性。每个涉及状态更改的请求都会被分配一个单调递增的 64 位事务编号，用于恢复时重新执行操作。服务端在故障后通过重放（replay）和重发（resend）机制恢复客户端请求，重放用于已收到成功回复的操作，重发用于未收到回复的操作。客户端维护重放列表，保存可能需要重放的请求，并在连接恢复后按事务编号顺序重放。服务器在恢复模式下等待客户端重新连接，收集信息以完成恢复过程。若重放序列中出现间隙，可能是由于回复丢失，客户端需在重发列表中保留相关请求以确保恢复完整。",
        "Lustre 文件系统通过 HSM（Hierarchical Storage Management）管理数据在文件系统与存储解决方案之间的迁移。请求包括 ARCHIVE、RELEASE、RESTORE、REMOVE 和 CANCEL，其中 RELEASE 是同步操作，其他由 MDT 协调处理。默认请求超时时间为 3600 秒，可通过命令设置。自动恢复机制在访问已释放文件时触发，IO 会被阻塞直到恢复完成。用户可通过命令监控请求状态和文件状态，文件状态包括 NOARCHIVE、NORELEASE、DIRTY 和 LOST。调试工具可控制协调器行为、设置最大请求数、调整策略及 grace delay。HSM 变更日志记录相关事件类型，如存档、恢复、取消等。"
    ],
    "contents": [
        "Lustre超时机制确保RPC会在有限的时间内处理可能发生的故障。自适应超时机制在默认情况下是启用的。如需在运行时禁用自适应超时机制，可以通过在MGS上运行将 at_max 设置为0。关于自适应超时机制的介绍，请参看参数adaptive_timeout_min。请注意，在运行时改变自适应超时的状态可能会导致瞬时的客户端超时、恢复和重连。在Lustre超时发生时，通常会在控制台打印一条控制台信息。如果Lustre超时没有伴随LND超时，请在服务器和客户端同时增加Lustre超时时长。本参数控制客户端等待服务器完成RPC的时间 (默认为100秒) 。服务器等待正常客户端RPC完成的时间是该超时时间的一半，等符单个批量请求〈最大4MB的读或写) 完成的时间是该时间的四分之一。客户端会每过四分之一的超时时间，ping一次可恢复的目标 (MDS和OST) ，在驱逐超时的客户端之前，服务器会等待超时时间的1.5倍。在指定时间内，如果Lustre客户端和某个服务器没有任何通信，该客户端会定期向的服务器发送ping信息。如果客户端和服务器之间存在任何网络活动，这个RPC也被认作是一个ping。作者: 李希 更新时间: 2023年6月7日\nLustre 可调参数全解133. mdt_req_buffer_history max: 设置MDT服务的最大历史请求数133.1 简介本参数用来设置MDT服务的最大历史请求数。每个服务都会维护一个请求历史，这对故障排查很有用。如果请求历史的缓冲区大小超过了本参数的值，就会从服务请求缓冲区历史中删除一些缓冲区，请求也会从服务请求历史中删除。关于MDT服务的类型，请参看参数mdt_nrs_policies。133.2 设置方法将所有MDT的 mds.MDS.{{ service }}.req buffer history max 设置为{{ max }};将MGS的 mds.MDS.{{ service }}.req buffer history max 设置为{{ max }}.134. ost_req_buffer_history max: 设置OST服务的最大历史请求数134.1 简介本参数用来设置OST服务的最大历史",
        "}} 。98. adaptive timeout_max: 设置自适应超时机制的最长超时时间98.1 简介本参数用来设置自适应超时机制的最长超时时间。本参数是对RPC服务时间的上限估计。如果服务时间达到 at_max ，RPC请求超时。将 at_max 设置为 0 会禁用自适应超时机制，而使用固定超时方法。如果硬件缓慢导致服务估计时间增加到超过 at_max 的默认值，请将 at_max 增加到愿意等待RPC完成的最大时间。关于自适应超时机制的介绍，请参看参数adaptive_ timeout_min.98.2 设置方法将Lustre客户端或服务器的 at_max 设置为 {{ seconds }};将MGS的 at_max 设置为 {{ seconds }} 。99. adaptive_timeout_history: 设置自适应超时机制最慢事件的历史时长99.1 简介本参数用来设置自适应超时机制最慢事件的历史时长。自适应超时机制需要记录历史上发生的事件，以根据历史对超时时长进行自适应调整。本参数控制记忆时长，单位是秒，默认是 600 。关于自适应超时机制的介绍，请参看参数adaptive_ timeout_min.99.2 设置方法将Lustre客户端或服务器的 at history 设置为 {{ seconds }};将MGS的 at_history 设置为 {{ seconds }} 。100. at_early margin: 设置在超时发生前多长时间发送提前回复以避免客户端超时100.1 简介本参数用来设置在超时发生前多长时间发送提前回复 (Early Reply) 以避免客户端超时。作者: 李希 更新时间: 2023年6月7日\nLustre 可调参数全解103. commit on_sharing: 设置是否提交被其他客户端依赖的事务103.1 简介本参数用来设置在其他客户端执行了一个具备依赖性的事务 Uournal) 时，是否提交被依赖的事务。共享时提交 (Commit On Sharing, COS) 功能增加了Lustre文件系统恢复的可靠性，因为该功能可以防止被驱逐的客户端连带着引起其他客户端被驱逐。司用COS后，如果一些Lustre客户端",
        "。共享时提交 (Commit On Sharing, COS) 功能增加了Lustre文件系统恢复的可靠性，因为该功能可以防止被驱逐的客户端连带着引起其他客户端被驱逐。司用COS后，如果一些Lustre客户端在服务器重启或故障后错过了恢复窗口，剩下的客户端不会因此被驱逐。为了说明COs是如何工作的，让我们先看一下没有COSs的恢复方式。在服务重局后，MDS9将局动并进入恢复模式。客户端开始重新连接并重新执行他们未提交的事务。客户端可以独立地重新执行事务，只要这些事务不相互依赖 (一个客户端的事务不依赖另一个客户端的事务) 。MDSs能够通过基于版本的恢复 (Version-basedRecovery) 这一功能来确定一个事务是否依赖于另一个事务。如果客户端事务之间存在着依赖关系 〈例如，创建和删除同一个文件) ，而其中一个或多个客户端没有及时地重新连接，那么这些客户端可能因为它们的事务依赖于被驱逐的客户端的事务，因而跟着被驱逐。而驱逐这些客户端又会导致更多的客户端被驱逐，从而导致客户端接二连三地被级联驱逐。COS通过消除客户端之间的事务依赖来解决级联驱逐的问题。如果另一个客户端的事务依赖于此客户端的某事务，COS会确保将该事务提交到磁盘。由于客户端不会依赖于其他客户端的未提交事务，因此客户端可以独立地重放其Ta KM ARBRE,本参数控制是否启用共享时提交功能。默认情况下，共享时提交功能是禁用的。103.2 设置方法将所有MDT的 mdt.{{ service name }} .commit on _ sharing 设置为{{ enable }};将MGS的mat.{{ filesystem.fsname }}-MDTx .commit on _ sharing 设置为{{ enable }} 。104. timeout: 设置客户端等待服务器完成RPC的时限104.1 简介本参数用来设置客户端等待服务器完成RPC的时限。在不启用自适应超时机制 (Adaptive Timeout) 的情况下，Lustre超时机制确保RPC会在有限的时间内处理可能发生的故障。自适应超时机制在默认情况下是启用的。如需在运行时禁用自适应超时机制，可以通过在MGS上运行将 at_max",
        "无法提交请求。。Ppurge: 清除所有记录的请求。不改变协调器状态。307\nLustre 文件系统操作手册这ay26.6.2. max requestsmax requests jéla] WYANT RAL (BED Dia) 。该值与代理数量无Ko例如，如果有2个MDT 和4个代理，代理不需要处理 2 倍的max_1 $ lctl set param mdt.SFSNAME-MDTO000.hsm.max requests=1026.6.3. policy更改系统行为，其值可以通过将+ 或 (EA BOR ASI AE BR1 $ lctl set Param mdt.SFSNAME-MDTO000.hsm.policy=+NRA可 以是以下情况组合的值:* NRA: 不进行重坛。如果恢复失败，不自动重调度请求。。NBR : 不阻塞 IO 来等待恢复。即触发恢复 ，但不阻塞客户端。访|返回 ENODRATA。26.6.4. grace delayrequests.可已释放的文件grace_delay 指的从整个请求列表中清除请求〈成功或失败) 的延迟，单位为秒。1 $ lctl set param mdqt.SESNAMPE-MDT0000.nhsm.grace delay=1026.7. 变更日志Lustre S/F RBCS Shae HSM 相关事件的类型为 HSM 的变更日志。1 16HSM 13:49:471.469433938 2013.10.01 0x280 t=[0x200000400: 0x1: 0x0]有 i 信息可以写入每条 HSM 记录: 变更文件的FID AI ACHENS. fey LA下信息进行编码 〈最低位在前)错误代码〈如采存在) (7 bits)。 HSM 事件 (3 bits)* HE ARCHIVE = 0: 文件已被存档。。 HE RESTORE = 1: 文件已恢复。。 HE CANCEL = 2: 关于此文件的请求已被取消。* HE RELEASE = 3: 文件已被释放。* HE REMOVE = 4: 已删除的请求被自动执行。\"HE_STATE = 5 : 文件标志已更改。308\nLustre 文件系统操作手册",
        "。每个客户端会报告最近一次的事务，以便服务器获知何时所有事务完成重放。客户端还会报告先前等竺请求完成的时间，用于帮助服务器估计某些客户端可能需要多长时间来检测服务吉故障并重新连接。如果客户端在重放期间超时，则会尝试重新连接。如果客户端无法重新连接，则REPLAY和失败并返回DISCON状态。客户端可能会在REPLAY期间频每地超时，因此重新连接不应该使已经很慢的进程延展过久。我们可以通过在重放期间增加超时时间来绥解这种情况。38.2.6. 请求重放如果客户端先前已连接，则会从服务万获得响应，得知服务器正在进行恢复，并获知人磁盘上最后提交的事务编导。然后，洛户端便可以过历其重放列表并使用此最后提交的事务编号来删除任何先前提交的请求。它按照事务编号的顺序回服务需重放任何较新465\nLustre 文件系统操作于册 译痢:As大的请求，一次一个，收到服务融的回复后再重放下一个请求。重放列表上的\" 打开请求\" 的事务编号可能小于服务硕上次提交事务的编号。服务骨将立即处理这些打开请求，然后再按照事务编号顺序处理来自客户端的重放请求。从最后提交事务的编号开始，确保状态在磁盘上以与故障之前完全相同的方式更新。在处理每个重放请求时，最后提交的事务编号将递增。如果服务货从客户端收到大于当前的最后提交事务编号的重放请求，则该请求会被搁置，直到其他客户端发起干预事务。服务般以这种方式按照驳前在服务郁上执行的相同顺序重放请求，直到所有客户端无请求可重放或序列中存在间隐。38.2.7. 重放序列中的间隙在菜些情况下，回复序列中可能会出现间陀。这可能是回复丢失引起的，即请求已处理并提交到人磁盘，但客户端未收到回复; 也可能是由于部分网络必障或客户端朋误导致回复无法发送至客户端造成的。在所有客户端都已重靳连接但重放序列仍存在间隐的情况下，唯一的可能是服务融处理了一些请求但是回复丢失了。客户站必须在其重发列表中包含这些请求，以便恢复宛成后进行重发。如有果所有客户端都未重新连接，则故隐客户端可能有",
        "收到了请求，但在发送故障前无法回复或提交到磁窟。464\nLustre 文件系统操作手册 译者:As大38.2.4. 客户端重放列表在服务融发生故障的情况下，进行服务种状态恢复〈重放) 可能需要所有文件系统修改请求。所收到的来目服务融的包含比最后提交的事务编号更大的事务标号的回复将被保留重放列表中，每个服务天都有一个这样的重必列表。也就是说，当从服务需接收到回复时，检查它是否具有比先前的最后提交的事务编号还大的事务编号。大多数具有较小事务编号的请求可以安全地从重放列表中删除。请注意，\" 打开请求\" 在这里是一个例外，它需要保存在重放列表中直到文件关闭，以便 MDS 可以正确引用 open-unlinked文件的计数。38.2.5. 服务器恢复如果服务器未完全关闭，则会进入恢复状态。服务器启动时，如果先前连接的客户端在last_rcvq文件中有任何客户端条目，则服务器进入恢复模式，等待这些客户端重新连接并开始重放或重发其请求。这将允许服务吉重建已暴露给客户端 〈成功完成的请求) 但在故障前未提交到磁盘的状态。不进行任何客户端连接尝试的情况下，服务器将无限期地等待客户端重新连接。这旨在处理服务器存在网络问题时客户端无法重连或需要反复重启服务器来解决硬件或软件问题的情况。一旦服务器检测到客户端的连接尝试〈新客户端或先前连接的客户端) ，无论先前连接的客户端是否可用，恢复计时器都将启动并强制在有限时间内完成恢复。如果Last_rcvq文件中没有客户端条目，或管理员手动中止恢复，则服务器不会等待客户端重新连接，而是允许所有客户端进行连接。当客户端连接时，服务器从每个连接处收集信息以确定需要多长时间来完成恢复。每个客户端将报告其连接 UUID ，服务器在last_zrcvdq文件中碍找此 UUID 来确定此客户端之前是否已连接。如果没有，将拒绝此客户端的连接直到恢复完成。每个客户端会报告最近一次的事务，以便服务器获知何时所有事务完成重放。客户端还会报告先前等竺请求完成的时间，用于帮助服务器估计某些客户端可能需要多长时间来检测服务吉故障并重新连接。如果客户端",
        "一个或多个 copytool 实例可能会遇到导致它们无法啊应的情况。为避免系统阻塞对相关文件的访问，我们为请求处理定义了一个超时值。copytool 必须在这上段时间内完全完成请求，其默认值为 3600 秒。1 $ lctl set param -n mdt.lustre-MDT0000.hsm.active request timeout305\nLustre 文件系统操作手册这ay26.4.每个26.4.请求文件系统和 HSM 解决方案之间的数据管理是由请求驱动的。有以下五种类型 :ARCHIVE: 从 Lustre 文件系统揽贝数据至 HSM 解决方案。RELEASE : 从 Lustre 文件系统移除数据。RESTORE : 从 HSM 解决方案拷回数据至相应的 Lustre 文件系统。REMOVE : 从HSM 解决方案中删除拷贝数据。CANCEL : 取消进行中或等待中的请求。JAA RELEASE 是同步进行且不需要协调需配合的操作。其他请求由协调锅处理，MDT 协调釉对和它们进行弹性的管理。1. 命令请求通 了过1fs ff 6人 th Ae:1 $ lfs hsm archive [--archive=ID] FILE1 [FILE2...]2 $ lfs hsm release FILE1 [FILE2...]3 $ lfs hsm restore FILE1 [FILE2...]4 $ fs hsm remove FILE1 [FILE2...]26.4如果没有通过 --archive #$% ARCHIVE ID ，请求将被发送到默认 ARCHIVE ID..2. 自动恢复当一个进程试图读取或修改已释放的文件时，它们将被被目动恢复。相关 IO 将被阻塞文件1 S ca直到文件恢复完成。这些操作对进程来说是透明的。例如，以下命令将自动恢复该(如果它已被释放) :t /mnt/lustre/released file26.4.3. 请求监控1 S 1Lc可以监控每个 MDT 上的已注册请求列表和它们的状况，运行:tl get Param -n mdt.lustreMDT0000.hsm.actions当前复制工具正在处理的请求列表可通过以下命令获取:1 $ lctl get param -n mdt.lustre-MDTO0000.",
        ":tl get Param -n mdt.lustreMDT0000.hsm.actions当前复制工具正在处理的请求列表可通过以下命令获取:1 $ lctl get param -n mdt.lustre-MDTO0000.hsm.active requests306\nLustre 文件系统操作手册 译者:这ay26.5. 文件状态当文件被存档〈释放) ，它们在 Lustre 文件系统上的状态发生改变。使用以下1fs命令碍看文件状态:1 $ lfs hsm State FILE1 [FILE2...]可以为每个文件设置以下的特定策略标志:* NOARCHIVE : 该文件永远不会被存档。* NORELEASE : 该文件永远不会被释放。如果已经设置了RELEASED标志，则不能再设置此标志。。DIRTY: 文件在复制到 HSM 解决方案后发生了更改。DIRTY 文件需要再次存档。DIRTY 标志只能在已有EXIST标志的情况下设置。以下选项只能由 root 用户设置 :。 LOST: 该文件已存档，但其在 HSM 解雇方案上的副本由于某种原因 (如磁盘损坏) 丢失，并且不能进行恢复。如果该文件处于 RELEASE 状态，则文件丢失; 如果不处于RELEASE 状态，则该文件需要再次存档。有些标志可通过以下命令手动设置或清除:1S 1fs hsm set [FLAGS] FILE] [FILE2...]2 $ lfs hsm clear [FLAGS] FILE1 [FILE2...]26.6. 调试26.6.1. hsm_controlpolicyhsm control 负责控制协调堪活动并可以祖除动作列表。1 $ lctl set Param mdt.SFSNAME-MDTO000.hsm_control=purge可能的值有:。enabled : 司动协调需线程。在可用复制工具实例上分发请求。。 disabled: 暂停协调器活动，将不进行新请求分发，不处理超时。新的请求会被注册，但只有协调喜重新启动后才会进行处理。。 shutdown : 关闭协调器线程。将无法提交请求。。Ppurge: 清除所有记录的请求。不改变协调器状态。307\nLustre 文件系统操作手册这ay26.6.2. max requestsmax requests jéla] WYANT RAL (BED",
        "发送的所有请求进行排序，直到请求被分配事务编号。XID 还可用于重新生成回复 ，以唯一地标识服务右上的每个客户端的请求。38.2.2. 事务编号服务器会分配一个事务编号给服务器处理的每个涉及状态更改〈元数据更新、文件打开、写入等，具体取决于服务需类型) 的客户器请求。该事务编号对于目标来说是唯一的，工作于服务套范围，是单调递增的 64 位整数。每个文件系统修改请求的事务纺人将与客户端请求的回复一起发回客户靖。事务编号允许客户端和服务禹明确地对每个文件系统更改进行排序，以便需要时进行恢复。发送给客户端的每个回复 〈无论请求类型如何) 还包含最后提交事务的编号，显示了提交给文件系统的事务编号的最大值。Lustre 软件使用的1diskfs和ZEFS后备文件系统确保了在随后的磁盘操作开始之前将早期磁盘操作提交到磁盘，最后提交的事务的编号还指示了任何具有更小事务山号的请求已被提人交到做盘。38.2.3. 重放和重发恢复 Lustre 文件系统可以分为两种不同类型的操作: 重放 (replay) 和重发 (resend) 。重放操作针对的是客户站已从服务硕收到操作成功的回复的那些操作。在服务融重司后，需要以和服务厚故障前报告的完全相同的方式重新执行这些操作。只有在服务骨发生故障时才能进行重放，否则和内存中并不会于失任何状态。重发操作针对的是客户端从未收到回复的那些操作，也就是说客户器并不知道它们的最终状态。客户奖近照 XID 的顺序再次癌服务硕发送未应答的请求，并等竺每个请求的回复。在某些情况下，重新发送的请求已由服务着处理并提交到磁盘〈可能还提交了相关操作) ，则服务硕将重新生成丢失的回复。在其他情况下，服务贷根本没有收到请求〈网络中断会发生这种状况) ，将像处理任何正半请求一样重新处理这些请求。服务需也可能收到了请求，但在发送故障前无法回复或提交到磁窟。464\nLustre 文件系统操作手册 译者:As大38.2.4. 客户端重放列表在服务融发生故障的情况下，进行服务种状态恢复"
    ]
}